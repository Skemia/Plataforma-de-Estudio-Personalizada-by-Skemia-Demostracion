<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skemia - Herramienta Educativa Integrada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Estilos personalizados y utilidades de Tailwind */
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        .page-content {
            display: none; /* Ocultar todas las páginas por defecto */
        }
        .page-content.active {
            display: block; /* Mostrar solo la página activa */
        }
        
        /* Estilos para el efecto de volteo 3D de la flashcard */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        /* Estilo para la barra de progreso discreta */
        .progress-bar-container {
            @apply w-full bg-gray-200 rounded-full h-2 overflow-hidden;
        }

        .progress-bar {
            @apply bg-purple-700 h-2 rounded-full transition-all duration-300 ease-in-out;
        }
        /* Estilo para el botón de shuffle activo */
        .shuffle-btn.active {
             @apply bg-brand-accent text-white;
        }
        .multi-select-dropdown::-webkit-scrollbar {
            width: 8px;
        }
        .multi-select-dropdown::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 4px;
        }
    </style>
    <script>
        // Configuración de Tailwind para que coincida con el diseño
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'neutral-bg': '#f9f9f9',
                        'neutral-card': '#ffffff',
                        'neutral-border': '#e5e5e5',
                        'text-primary': '#1a1a1a',
                        'text-secondary': '#666666',
                        'brand-accent': '#5F476B',
                        'feedback-correct': '#22c55e',
                        'feedback-incorrect': '#ef4444',
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-neutral-bg text-text-primary min-h-screen flex flex-col">

    <header class="bg-neutral-card border-b border-neutral-border sticky top-0 z-20">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" class="text-xl font-bold text-brand-accent" data-page="home">Skemia</a>
            
            <div class="md:hidden">
                <button id="mobile-menu-button" class="text-text-primary focus:outline-none">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>

            <div id="navigation-links" class="hidden absolute top-full left-0 w-full bg-neutral-card border-b md:border-none md:static md:w-auto md:flex md:items-center md:bg-transparent">
                <div class="flex flex-col md:flex-row items-start md:items-center p-4 md:p-0 space-y-3 md:space-y-0 md:space-x-6 text-text-secondary w-full">
                    <a href="#" class="hover:text-text-primary w-full" data-page="flashcards">Flashcards</a>
                    <a href="#" class="hover:text-text-primary w-full" data-page="quizzes">Quizzes</a>
                    <a href="#" class="hover:text-text-primary w-full" data-page="mindmap">Mapas Mentales</a>
                    <a href="#" class="hover:text-text-primary w-full" data-page="audios">Audios</a>
                    <a href="#" class="hover:text-text-primary w-full" data-page="report">Informes</a>
                    <a href="#" class="hover:text-text-primary w-full" data-page="fuentes">Fuentes</a>
                    <a href="#" class="hover:text-text-primary w-full font-bold" data-page="progreso">Mi Progreso</a>
                </div>
            </div>
        </nav>
    </header>

    <main class="flex-grow container mx-auto px-6 py-8">
        
        <section id="page-home" class="page-content active">
            <div class="grid lg:grid-cols-2 gap-16 items-center min-h-[60vh]">
                <div class="text-center lg:text-left">
                    <h1 class="text-4xl lg:text-5xl font-bold text-gray-800 mb-4 leading-tight">
                        Transforma tu manera de estudiar.
                    </h1>
                    <p class="text-lg text-gray-600 mb-8 max-w-lg mx-auto lg:mx-0">
                        Skemia te ofrece todas las herramientas que necesitas en un solo lugar. Flashcards, quizzes, mapas mentales y más, diseñados para un aprendizaje sin distracciones.
                    </p>
                    <a href="#" id="start-studying-btn" class="inline-block bg-brand-accent text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-opacity-90 transition-transform transform hover:scale-105">
                        Empezar a estudiar
                    </a>
                </div>
                <div class="hidden lg:block p-4">
                    <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:rgb(230, 230, 250);stop-opacity:1" />
                                <stop offset="100%" style="stop-color:rgb(200, 200, 240);stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <path fill="url(#grad1)" d="M48.8,-63.9C63.2,-53.9,74.7,-40.1,79.8,-24.1C84.9,-8.1,83.6,10.2,75.4,24.3C67.2,38.5,52.1,48.6,37,56.5C21.9,64.4,6.9,70.1,-8.5,70.9C-24,71.7,-39.9,67.6,-51.9,58.3C-63.9,49,-72,34.5,-75.8,18.5C-79.6,2.5,-79.1,-15,-71.5,-29.4C-64,-43.8,-49.4,-55.1,-34.5,-63.7C-19.6,-72.3,-4.5,-78.2,10,-79.4C24.5,-80.6,34.5,-73.9,48.8,-63.9Z" transform="translate(100 100)" />
                        <circle cx="150" cy="50" r="10" fill="#5F476B"/>
                        <circle cx="60" cy="160" r="5" fill="#5F476B" opacity="0.7"/>
                        <rect x="40" y="40" width="20" height="20" rx="5" fill="#5F476B" opacity="0.5" transform="rotate(45 50 50)"/>
                    </svg>
                </div>
            </div>
        </section>

        <section id="page-flashcards" class="page-content">
            <div class="flex flex-col items-center space-y-8">
                <div class="w-full max-w-2xl text-center">
                    <h1 class="text-3xl font-bold mb-4">Flashcards</h1>
                    <div id="flashcard-selection-area" class="w-full max-w-2xl mx-auto text-left space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">1. Selecciona uno o más temarios:</label>
                            <div class="relative" id="multi-select-container">
                                <button id="multi-select-button" class="w-full bg-white p-2 border border-neutral-border rounded-md flex justify-between items-center text-left">
                                    <span id="multi-select-text" class="text-text-secondary">Selecciona temarios...</span>
                                    <i data-lucide="chevron-down" class="w-5 h-5"></i>
                                </button>
                                <div id="multi-select-dropdown" class="absolute hidden w-full mt-1 bg-white border rounded-md shadow-lg z-20 max-h-60 overflow-y-auto multi-select-dropdown">
                                    </div>
                            </div>
                        </div>

                        <div id="flashcard-session-options" class="hidden space-y-2 pt-2">
                            <label class="block text-sm font-medium text-text-secondary">
                                2. Elige cuántas tarjetas estudiar (de <span id="flashcard-total-count" class="font-bold">0</span> en total):
                            </label>
                            <input id="flashcard-session-size" type="number" placeholder="Todas" class="w-full p-2 border border-neutral-border rounded-md bg-white">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-500">Rápido:</span>
                                <button data-size="25" class="size-btn-flashcards px-3 py-1 text-sm bg-gray-200 rounded-md hover:bg-gray-300">25</button>
                                <button data-size="50" class="size-btn-flashcards px-3 py-1 text-sm bg-gray-200 rounded-md hover:bg-gray-300">50</button>
                                <button data-size="100" class="size-btn-flashcards px-3 py-1 text-sm bg-gray-200 rounded-md hover:bg-gray-300">100</button>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4 pt-2">
                            <button id="start-flashcards-btn" class="flex-grow px-6 py-2 bg-brand-accent text-white rounded-md hover:bg-opacity-90 disabled:bg-gray-300">
                                Empezar Estudio
                            </button>
                             <button id="flashcard-shuffle" title="Barajar tarjetas antes de empezar" class="shuffle-btn p-2 bg-neutral-card border rounded-md hover:bg-neutral-bg transition-colors">
                                 <i data-lucide="shuffle" class="w-5 h-5"></i>
                             </button>
                        </div>
                    </div>
                </div>

                <div id="flashcard-study-area" class="hidden w-full max-w-2xl flex flex-col items-center space-y-8 pb-48 md:pb-8">
                    <div class="w-full flex justify-between items-center">
                           <button id="change-topics-btn" class="text-sm text-indigo-600 hover:underline">Cambiar Temas</button>
                           <span id="flashcard-counter" class="text-text-secondary text-sm font-mono"></span>
                           <button id="flashcard-shuffle-study" title="Re-barajar mazo y reiniciar" class="shuffle-btn p-2 bg-neutral-card border rounded-md hover:bg-neutral-bg transition-colors">
                                <i data-lucide="shuffle" class="w-5 h-5"></i>
                           </button>
                    </div>
                    <div id="flashcard-container" class="w-full max-w-2xl"></div>
                    
                    <div class="flex items-center justify-center flex-wrap gap-4">
                        <button id="save-flashcard-progress-btn" title="Guardar sesión actual" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 flex items-center justify-center space-x-2 text-sm">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            <span>Guardar Progreso</span>
                        </button>
                        <button id="flashcard-download" title="Descargar mazo completo en PDF" class="w-full md:w-auto px-4 py-2 bg-brand-accent text-white rounded-md hover:bg-opacity-90 flex items-center justify-center space-x-2 text-sm">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            <span>Descargar Mazo (PDF)</span>
                        </button>
                    </div>

                    <div id="flashcard-mobile-controls" class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-3 z-30 md:static md:bg-transparent md:border-none md:p-0">
                        <div class="w-full max-w-2xl mx-auto flex flex-col gap-3">
                            <div id="flashcard-difficulty-controls" class="w-full text-center">
                                 <p class="text-sm text-text-secondary mb-2 md:hidden">¿Qué tal te la sabes?</p>
                                 <div class="flex justify-center space-x-3">
                                      <button data-difficulty="easy" class="flex-1 px-4 py-2 bg-green-100 text-green-700 border border-green-200 rounded-md hover:bg-green-200 transition-colors">Fácil</button>
                                      <button data-difficulty="medium" class="flex-1 px-4 py-2 bg-yellow-100 text-yellow-700 border border-yellow-200 rounded-md hover:bg-yellow-200 transition-colors">Medio</button>
                                      <button data-difficulty="hard" class="flex-1 px-4 py-2 bg-red-100 text-red-700 border border-red-200 rounded-md hover:bg-red-200 transition-colors">Difícil</button>
                                 </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <button id="flashcard-prev" class="px-4 py-2 bg-neutral-card border rounded-md hover:bg-neutral-bg">Anterior</button>
                                <button id="flashcard-next" class="px-4 py-2 bg-neutral-card border rounded-md hover:bg-neutral-bg">Siguiente</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-quizzes" class="page-content">
            <div class="flex flex-col items-center space-y-8">
                <div class="w-full max-w-2xl text-center">
                    <h1 class="text-3xl font-bold mb-4">Quizzes</h1>
                    <div id="quiz-selection-area" class="w-full max-w-2xl mx-auto text-left space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">1. Selecciona uno o más temarios:</label>
                            <div class="relative" id="quiz-multi-select-container">
                                <button id="quiz-multi-select-button" class="w-full bg-white p-2 border border-neutral-border rounded-md flex justify-between items-center text-left">
                                    <span id="quiz-multi-select-text" class="text-text-secondary">Selecciona temarios...</span>
                                    <i data-lucide="chevron-down" class="w-5 h-5"></i>
                                </button>
                                <div id="quiz-multi-select-dropdown" class="absolute hidden w-full mt-1 bg-white border rounded-md shadow-lg z-20 max-h-60 overflow-y-auto multi-select-dropdown">
                                    </div>
                            </div>
                        </div>

                        <div id="quiz-session-options" class="hidden space-y-2 pt-2">
                            <label class="block text-sm font-medium text-text-secondary">
                                2. Elige cuántas preguntas hacer (de <span id="quiz-total-count" class="font-bold">0</span> en total):
                            </label>
                            <input id="quiz-session-size" type="number" placeholder="Todas" class="w-full p-2 border border-neutral-border rounded-md bg-white">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-500">Rápido:</span>
                                <button data-size="25" class="size-btn-quizzes px-3 py-1 text-sm bg-gray-200 rounded-md hover:bg-gray-300">25</button>
                                <button data-size="50" class="size-btn-quizzes px-3 py-1 text-sm bg-gray-200 rounded-md hover:bg-gray-300">50</button>
                                <button data-size="100" class="size-btn-quizzes px-3 py-1 text-sm bg-gray-200 rounded-md hover:bg-gray-300">100</button>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4 pt-2">
                            <button id="start-quiz-btn" class="flex-grow px-6 py-2 bg-brand-accent text-white rounded-md hover:bg-opacity-90 disabled:bg-gray-300">
                                Empezar Quiz
                            </button>
                             <button id="quiz-shuffle-selection" title="Barajar preguntas" class="shuffle-btn p-2 bg-neutral-card border rounded-md hover:bg-neutral-bg transition-colors">
                                 <i data-lucide="shuffle" class="w-5 h-5"></i>
                             </button>
                        </div>
                    </div>
                </div>

                <div id="quiz-study-area" class="hidden w-full max-w-2xl flex-col items-center space-y-8 pb-24 md:pb-8">
                           <div class="w-full flex justify-between items-center">
                                 <button id="change-quiz-topics-btn" class="text-sm text-indigo-600 hover:underline">Cambiar Temas</button>
                                 <button id="quiz-shuffle-study" title="Reiniciar y barajar" class="shuffle-btn p-2 bg-neutral-card border rounded-md hover:bg-neutral-bg transition-colors">
                                     <i data-lucide="shuffle" class="w-5 h-5"></i>
                                 </button>
                           </div>
                           <div id="quiz-container" class="w-full">
                               </div>
                </div>
            </div>
        </section>

        <section id="page-mindmap" class="page-content">
             <div class="max-w-2xl mx-auto text-center">
                  <h1 class="text-3xl font-bold mb-4">Mapas Mentales</h1>
                  <div class="mb-6">
                       <label for="mindmap-temario-select" class="block text-sm font-medium text-text-secondary mb-1">Selecciona un temario:</label>
                       <select id="mindmap-temario-select" class="temario-selector w-full p-2 border border-neutral-border rounded-md bg-white"></select>
                  </div>
                  <div id="mindmap-url-container"></div>
             </div>
        </section>

        <section id="page-audios" class="page-content">
             <div class="max-w-2xl mx-auto text-center">
                  <h1 class="text-3xl font-bold mb-4">Audios Descargables</h1>
                  <div id="audios-download-container">
                       </div>
             </div>
        </section>

        <section id="page-report" class="page-content">
            <div class="max-w-2xl mx-auto text-center">
                <h1 class="text-3xl font-bold mb-4">Informes Descargables</h1>
                <div id="report-download-container">
                    </div>
            </div>
        </section>

        <section id="page-fuentes" class="page-content">
             <div class="max-w-2xl mx-auto text-center">
                  <h1 class="text-3xl font-bold mb-4">Fuentes de Información</h1>
                  <div id="fuentes-download-container">
                       </div>
             </div>
        </section>

        <section id="page-progreso" class="page-content">
            <div class="max-w-5xl mx-auto">
                <h1 class="text-3xl font-bold mb-8 text-center">Panel de Progreso</h1>
                
                <div id="progress-container" class="space-y-8">
                    </div>

                <div id="session-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="modal-title" class="text-xl font-bold">Detalles de la Sesión</h3>
                            <button id="modal-close-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
                        </div>
                        <div id="modal-content" class="text-left">
                            </div>
                    </div>
                </div>

            </div>
        </section>
    </main>
    
    <footer class="text-center py-4 text-text-secondary text-sm border-t border-neutral-border mt-8">
        © <span id="footer-year"></span> Skemia. Herramienta educativa.
    </footer>

    <script>
    const { jsPDF } = window.jspdf;

    document.addEventListener('DOMContentLoaded', async () => {

        let MOCK_DATA;

        try {
            const response = await fetch('datos.json');
            if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
            MOCK_DATA = await response.json();
        } catch (error) {
            console.error("Error crítico: No se pudieron cargar los datos de la aplicación.", error);
            document.querySelector('main').innerHTML = `<div class="text-center p-8 bg-red-50 border border-red-200 rounded-lg"><h1 class="text-2xl font-bold text-red-700">Error al Cargar Contenido</h1><p class="text-gray-600 mt-2">No se pudo obtener la información necesaria para la aplicación. Por favor, revisa la consola (F12) o recarga la página.</p></div>`;
            return;
        }
        
        let AppState = {
            currentTemarioIndex: 0,
            flashcards: { selectedTemarioIndices: [], combinedFlashcards: [], currentIndex: 0, isFlipped: false, difficulty: {} },
            quizzes: { selectedTemarioIndices: [], combinedQuizzes: [], currentIndex: 0, selectedAnswer: null, isAnswered: false, score: 0, userAnswers: [], isReviewMode: false, isEarlyFinish: false }
        };

        function getProgressData() {
            const data = localStorage.getItem('skemiaProgress');
            return data ? JSON.parse(data) : {};
        }

        function saveProgressData(progressData) {
            localStorage.setItem('skemiaProgress', JSON.stringify(progressData));
        }

        function addProgressRecord(temarioNames, record) {
            const progress = getProgressData();
            record.sessionId = `${record.type.slice(0, 2)}-${new Date().getTime()}`;
            record.temarioNames = temarioNames;
            const generalLogId = 'allSessions';
            if (!progress[generalLogId]) progress[generalLogId] = [];
            progress[generalLogId].push(record);
            saveProgressData(progress);
        }

        const pages = document.querySelectorAll('.page-content');
        const navLinks = document.querySelectorAll('header nav a');
        const temarioSelectors = document.querySelectorAll('.temario-selector');
        document.getElementById('footer-year').textContent = new Date().getFullYear();

        function navigateTo(pageId) {
            pages.forEach(page => page.classList.toggle('active', page.id === `page-${pageId}`));
            const activePage = document.querySelector('.page-content.active');
            if (activePage) {
                const pageLogic = activePage.id.replace('page-', '');
                if (pageLogic === 'flashcards') setupFlashcardsPage();
                if (pageLogic === 'quizzes') setupQuizzesPage();
                if (pageLogic === 'mindmap') renderMindmapPage();
                if (pageLogic === 'audios') renderDownloadPage('audios');
                if (pageLogic === 'report') renderDownloadPage('report');
                if (pageLogic === 'fuentes') renderDownloadPage('fuentes');
                if (pageLogic === 'progreso') renderProgressPage();
            }
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = e.currentTarget.dataset.page;
                if (page) navigateTo(page);
            });
        });
        
        function populateTemarioSelectors() {
            temarioSelectors.forEach(selector => {
                selector.innerHTML = '';
                MOCK_DATA.temarios.forEach((temario, index) => {
                    selector.innerHTML += `<option value="${index}">${temario.name}</option>`;
                });
                selector.value = AppState.currentTemarioIndex;
            });
        }

        function handleTemarioChange(event) {
            const newIndex = parseInt(event.target.value, 10);
            AppState.currentTemarioIndex = newIndex;
            temarioSelectors.forEach(s => s.value = newIndex);
            const activePageId = document.querySelector('.page-content.active').id.replace('page-', '');
            navigateTo(activePageId);
        }
        
        document.querySelectorAll('.temario-selector').forEach(selector => selector.addEventListener('change', handleTemarioChange));
        document.getElementById('start-studying-btn').addEventListener('click', (e) => { e.preventDefault(); navigateTo('flashcards'); });

        const fcSelectionArea = document.getElementById('flashcard-selection-area');
        const fcStudyArea = document.getElementById('flashcard-study-area');
        const startFlashcardsBtn = document.getElementById('start-flashcards-btn');
        const fcContainer = document.getElementById('flashcard-container');
        const fcPrevBtn = document.getElementById('flashcard-prev');
        const fcNextBtn = document.getElementById('flashcard-next');
        const fcCounter = document.getElementById('flashcard-counter');
        const fcShuffleBtn = document.getElementById('flashcard-shuffle');
        const fcShuffleStudyBtn = document.getElementById('flashcard-shuffle-study');
        const fcDownloadBtn = document.getElementById('flashcard-download');
        const fcDifficultyControls = document.getElementById('flashcard-difficulty-controls');
        const changeTopicsBtn = document.getElementById('change-topics-btn');
        const saveFlashcardProgressBtn = document.getElementById('save-flashcard-progress-btn');

        function setupFlashcardsPage() {
            setupMultiSelect('flashcards');
            fcSelectionArea.classList.remove('hidden');
            fcStudyArea.classList.add('hidden');
        }

        startFlashcardsBtn.addEventListener('click', () => {
            let allItems = [];
            AppState.flashcards.selectedTemarioIndices.forEach(index => allItems.push(...MOCK_DATA.temarios[index].flashcards));

            if (fcShuffleBtn.classList.contains('active')) {
                for (let i = allItems.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allItems[i], allItems[j]] = [allItems[j], allItems[i]];
                }
            }
            
            const sizeInput = document.getElementById('flashcard-session-size');
            const sessionSize = parseInt(sizeInput.value, 10);
            
            let finalDeck = allItems;
            if (!isNaN(sessionSize) && sessionSize > 0 && sessionSize < allItems.length) {
                finalDeck = allItems.slice(0, sessionSize);
            }

            AppState.flashcards.combinedFlashcards = finalDeck;

            fcSelectionArea.classList.add('hidden');
            fcStudyArea.classList.remove('hidden');
            fcStudyArea.classList.add('flex');
            resetFlashcardState();
            AppState.flashcards.combinedFlashcards = finalDeck; // Re-assign after reset
            renderFlashcard();
        });

        function saveCurrentFlashcardProgress() {
            const state = AppState.flashcards;
            const studiedCards = Object.keys(state.difficulty);
            if (studiedCards.length > 0) {
                const counts = { easy: 0, medium: 0, hard: 0 };
                studiedCards.forEach(cardId => {
                    const difficulty = state.difficulty[cardId];
                    if (counts[difficulty] !== undefined) counts[difficulty]++;
                });
                const temarioNames = state.selectedTemarioIndices.map(i => MOCK_DATA.temarios[i].name);
                const record = { type: 'flashcards', date: new Date().toISOString(), totalInDeck: state.combinedFlashcards.length, studiedCount: studiedCards.length, ...counts };
                addProgressRecord(temarioNames, record);
                
                const originalContent = saveFlashcardProgressBtn.innerHTML;
                saveFlashcardProgressBtn.innerHTML = `<span>¡Guardado!</span>`;
                saveFlashcardProgressBtn.disabled = true;
                setTimeout(() => {
                    saveFlashcardProgressBtn.innerHTML = originalContent;
                    lucide.createIcons();
                    saveFlashcardProgressBtn.disabled = false;
                }, 1500);
            } else {
                alert("No has estudiado ninguna tarjeta. No hay progreso que guardar.");
            }
        }

        changeTopicsBtn.addEventListener('click', () => {
            saveCurrentFlashcardProgress();
            setupFlashcardsPage();
        });

        saveFlashcardProgressBtn.addEventListener('click', saveCurrentFlashcardProgress);

        function resetFlashcardState() {
            const { selectedTemarioIndices } = AppState.flashcards;
            AppState.flashcards = { ...AppState.flashcards, selectedTemarioIndices, combinedFlashcards: [], currentIndex: 0, isFlipped: false, difficulty: {} };
        }

        fcShuffleStudyBtn.addEventListener('click', () => {
            const state = AppState.flashcards;
            if (state.combinedFlashcards.length === 0) return;
            for (let i = state.combinedFlashcards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [state.combinedFlashcards[i], state.combinedFlashcards[j]] = [state.combinedFlashcards[j], state.combinedFlashcards[i]];
            }
            state.currentIndex = 0;
            state.isFlipped = false;
            renderFlashcard();
            fcShuffleStudyBtn.classList.add('bg-brand-accent', 'text-white');
            setTimeout(() => fcShuffleStudyBtn.classList.remove('bg-brand-accent', 'text-white'), 300);
        });

        function addSkemiaHeader(doc, title) {
            const margin = 10, lineHeight = 6, titleFontSize = 14;
            let y = 15;
            const logoText = "Skemia";
            const pageWidth = doc.internal.pageSize.getWidth();
            const logoWidth = doc.getStringUnitWidth(logoText) * doc.internal.getFontSize() / doc.internal.scaleFactor;
            doc.setFontSize(20).setFont("helvetica", "bold").setTextColor("#5F476B").text(logoText, margin, y);
            doc.setFontSize(titleFontSize).setTextColor(0).setFont("helvetica", "bold");
            const logoEnd = margin + logoWidth;
            const titleStartX = logoEnd + 5; 
            const availableWidthForTitle = pageWidth - titleStartX - margin;
            if (doc.getStringUnitWidth(title) * titleFontSize / doc.internal.scaleFactor > availableWidthForTitle) {
                const splitTitle = doc.splitTextToSize(title, availableWidthForTitle);
                doc.text(splitTitle, titleStartX, y, { align: 'left' });
                y += splitTitle.length * lineHeight;
            } else {
                const centerPoint = titleStartX + (availableWidthForTitle / 2);
                doc.text(title, centerPoint, y, { align: 'center' });
                y += lineHeight;
            }
            doc.setFontSize(8).setFont("helvetica", "normal").setTextColor(150).text("Material propiedad de Skemia. Prohibida su difusión, reproducción o distribución.", margin, y);
            y += lineHeight;
            doc.line(margin, y, pageWidth - margin, y);
            y += lineHeight + 5;
            return y;
        }

        function downloadFlashcardsAsPDF() {
            if (AppState.flashcards.combinedFlashcards.length === 0) return alert("No hay tarjetas para descargar.");
            const doc = new jsPDF();
            const { combinedFlashcards, selectedTemarioIndices } = AppState.flashcards;
            const topicNames = selectedTemarioIndices.map(i => MOCK_DATA.temarios[i].name).join(', ');
            let y = addSkemiaHeader(doc, `Mazo de Flashcards: ${topicNames}`);
            combinedFlashcards.forEach((card, index) => {
                if (y > 280) {
                    doc.addPage();
                    y = addSkemiaHeader(doc, `Mazo de Flashcards: ${topicNames}`);
                }
                doc.setFontSize(14).setFont("helvetica", "bold").text(`Tarjeta ${index + 1}:`, 10, y);
                y += 7;
                doc.setFontSize(10).setFont("helvetica", "bold").text("P: ", 15, y);
                doc.setFont("helvetica", "normal");
                const frontLines = doc.splitTextToSize(card.front, 170);
                doc.text(frontLines, 20, y);
                y += (frontLines.length * 7) + 2;
                doc.setFont("helvetica", "bold").text("R: ", 15, y);
                doc.setFont("helvetica", "normal");
                const backLines = doc.splitTextToSize(card.back, 170);
                doc.text(backLines, 20, y);
                y += (backLines.length * 7) + 3.5;
                doc.line(10, y, 200, y);
                y += 7;
            });
            const fileName = `Skemia_Flashcards_${(MOCK_DATA.temarios[selectedTemarioIndices[0]]?.name || 'Mazo').replace(/[^\w\s]/gi, '').slice(0, 20).trim()}.pdf`;
            doc.save(fileName);
        }

        fcDownloadBtn.addEventListener('click', downloadFlashcardsAsPDF);

        function renderFlashcard() {
            const state = AppState.flashcards;
            const currentData = state.combinedFlashcards;
            if (currentData.length === 0) {
                fcContainer.innerHTML = `<div class="w-full h-80 flex items-center justify-center"><p class="text-text-secondary">No hay flashcards.</p></div>`;
                fcCounter.textContent = '0 / 0';
                return;
            }
            const card = currentData[state.currentIndex];
            const difficulty = state.difficulty[card.id];
            let borderColor = 'border-neutral-border';
            if (difficulty === 'easy') borderColor = 'border-green-400';
            else if (difficulty === 'medium') borderColor = 'border-yellow-400';
            else if (difficulty === 'hard') borderColor = 'border-red-400';
            fcContainer.innerHTML = `<div id="card-flipper" class="w-full h-80 rounded-xl shadow-xl cursor-pointer perspective-1000"><div class="relative w-full h-full transition-transform duration-700 transform-style-3d ${state.isFlipped ? 'rotate-y-180' : ''}"><div class="absolute w-full h-full backface-hidden flex flex-col items-center justify-center p-6 bg-white border-4 ${borderColor} rounded-xl"><p class="text-2xl font-semibold text-text-primary text-center">${card.front}</p><div class="absolute bottom-4 right-4 text-gray-300"><i data-lucide="rotate-cw" class="w-5 h-5"></i></div></div><div class="absolute w-full h-full backface-hidden rotate-y-180 flex flex-col items-center justify-center p-6 bg-neutral-bg border-4 ${borderColor} rounded-xl"><p class="text-lg text-text-secondary text-center">${card.back}</p>${card.audioUrl ? `<audio controls src="${card.audioUrl}" class="mt-4" onclick="event.stopPropagation()"></audio>` : ''}</div></div></div>`;
            fcCounter.textContent = `${state.currentIndex + 1} / ${currentData.length}`;
            document.getElementById('card-flipper').addEventListener('click', () => {
                state.isFlipped = !state.isFlipped;
                renderFlashcard();
            });
            lucide.createIcons();
        }
        
        fcPrevBtn.addEventListener('click', () => {
            const state = AppState.flashcards;
            if (state.combinedFlashcards.length === 0) return;
            state.isFlipped = false;
            state.currentIndex = (state.currentIndex - 1 + state.combinedFlashcards.length) % state.combinedFlashcards.length;
            renderFlashcard();
        });
        
        fcNextBtn.addEventListener('click', () => {
            const state = AppState.flashcards;
            if (state.combinedFlashcards.length === 0) return;
            state.isFlipped = false;
            state.currentIndex = (state.currentIndex + 1) % state.combinedFlashcards.length;
            renderFlashcard();
        });
        
        fcShuffleBtn.addEventListener('click', () => fcShuffleBtn.classList.toggle('active'));

        fcDifficultyControls.addEventListener('click', (e) => {
            if (e.target.matches('button')) {
                const difficulty = e.target.dataset.difficulty;
                const state = AppState.flashcards;
                const card = state.combinedFlashcards[state.currentIndex];
                if (card) state.difficulty[card.id] = difficulty;
                renderFlashcard();
                setTimeout(() => fcNextBtn.click(), 200);
            }
        });

        const quizContainer = document.getElementById('quiz-container');
        const quizSelectionArea = document.getElementById('quiz-selection-area');
        const quizStudyArea = document.getElementById('quiz-study-area');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const changeQuizTopicsBtn = document.getElementById('change-quiz-topics-btn');
        const quizShuffleSelectionBtn = document.getElementById('quiz-shuffle-selection');
        const quizShuffleStudyBtn = document.getElementById('quiz-shuffle-study');

        function setupQuizzesPage() {
            setupMultiSelect('quizzes');
            quizSelectionArea.classList.remove('hidden');
            quizStudyArea.classList.add('hidden');
        }

        quizShuffleSelectionBtn.addEventListener('click', () => quizShuffleSelectionBtn.classList.toggle('active'));

        startQuizBtn.addEventListener('click', () => {
            let allItems = [];
            AppState.quizzes.selectedTemarioIndices.forEach(index => {
                if (MOCK_DATA.temarios[index].quizzes) allItems.push(...MOCK_DATA.temarios[index].quizzes);
            });

            if (quizShuffleSelectionBtn.classList.contains('active')) {
                for (let i = allItems.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allItems[i], allItems[j]] = [allItems[j], allItems[i]];
                }
            }
            
            const sizeInput = document.getElementById('quiz-session-size');
            const sessionSize = parseInt(sizeInput.value, 10);
            
            let finalQuiz = allItems;
            if (!isNaN(sessionSize) && sessionSize > 0 && sessionSize < allItems.length) {
                finalQuiz = allItems.slice(0, sessionSize);
            }
            
            quizSelectionArea.classList.add('hidden');
            quizStudyArea.classList.remove('hidden');
            quizStudyArea.classList.add('flex');
            resetQuizState();
            AppState.quizzes.combinedQuizzes = finalQuiz;
            renderQuiz();
        });
        
        quizShuffleStudyBtn.addEventListener('click', () => {
            const state = AppState.quizzes;
            if (state.combinedQuizzes.length === 0) return;
            for (let i = state.combinedQuizzes.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [state.combinedQuizzes[i], state.combinedQuizzes[j]] = [state.combinedQuizzes[j], state.combinedQuizzes[i]];
            }
            resetQuizState();
            renderQuiz();
            quizShuffleStudyBtn.classList.add('bg-brand-accent', 'text-white');
            setTimeout(() => quizShuffleStudyBtn.classList.remove('bg-brand-accent', 'text-white'), 300);
        });

        changeQuizTopicsBtn.addEventListener('click', () => setupQuizzesPage());

        function resetQuizState() {
            const { combinedQuizzes, selectedTemarioIndices } = AppState.quizzes;
            AppState.quizzes = { ...AppState.quizzes, selectedTemarioIndices, combinedQuizzes, currentIndex: 0, selectedAnswer: null, isAnswered: false, score: 0, userAnswers: [], isReviewMode: false, isEarlyFinish: false };
        }

        function renderQuiz() {
            const state = AppState.quizzes;
            const data = state.combinedQuizzes;

            if (data.length === 0) {
                quizContainer.innerHTML = `<p class="text-text-secondary text-center">No hay quizzes.</p>`;
                return;
            }
            if (state.isReviewMode) {
                renderQuizReview();
                return;
            }
            if (state.currentIndex >= data.length) {
                renderQuizResults(data);
                return;
            }

            const question = data[state.currentIndex];
            let feedbackBoxHtml = '';
            if (state.isAnswered) {
                const userAnswer = state.userAnswers.find(ua => ua.questionId === question.id);
                let correctAnsHtml = '';
                if (userAnswer && !userAnswer.isCorrect && question.type === 'fill-in-the-blank') {
                    correctAnsHtml = `<p class="text-sm text-green-700">Respuesta correcta: <strong class="font-bold">${question.answer}</strong></p>`;
                }
                if (question.explanation || correctAnsHtml) {
                    feedbackBoxHtml = `<div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-md text-sm text-yellow-800">${correctAnsHtml}${question.explanation ? `<p class="mt-2">${question.explanation}</p>` : ''}</div>`;
                }
            }
            
            const actionButtonsHtml = `<div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-3 z-30 md:static md:bg-transparent md:border-none md:p-0"><div class="container mx-auto max-w-2xl flex items-center justify-between gap-4"><button id="quiz-finish-early" class="w-1/2 md:w-auto px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 flex items-center justify-center space-x-2 text-sm"><i data-lucide="flag" class="w-4 h-4"></i><span>Finalizar y Guardar</span></button><div class="w-1/2 md:w-auto">${state.isAnswered ? `<button id="quiz-next" class="w-full px-6 py-2 bg-brand-accent text-white rounded-md">Siguiente</button>`: `<button id="quiz-check" class="w-full px-6 py-2 bg-brand-accent text-white rounded-md disabled:bg-gray-300" ${!state.selectedAnswer ? 'disabled' : ''}>Comprobar</button>`}</div></div></div>`;
            
            quizContainer.innerHTML = `<div class="progress-bar-container mb-4"><div class="progress-bar" style="width: ${((state.currentIndex) / data.length) * 100}%"></div></div><p class="text-right text-sm text-text-secondary mb-8">Pregunta ${state.currentIndex + 1} de ${data.length}</p><div class="bg-neutral-card p-8 rounded-lg border"><h2 class="text-2xl font-semibold mb-6">${question.prompt}</h2><div class="space-y-3">${renderQuestionInput(question, state)}</div>${feedbackBoxHtml}</div>${actionButtonsHtml}`;
            attachQuizListeners(question, state);
        }

        function renderQuestionInput(question, state) {
            if (question.type === 'fill-in-the-blank') {
                 let inputClass = 'w-full p-3 border border-neutral-border rounded-md';
                 if (state.isAnswered) {
                      const userAnswer = state.userAnswers.find(ua => ua.questionId === question.id);
                      if (userAnswer) {
                          inputClass += userAnswer.isCorrect ? ' bg-green-50 border-green-300 text-green-800' : ' bg-red-50 border-red-300 text-red-800';
                      }
                 }
                 return `<div class="relative"><input type="text" id="fill-in-blank-input" class="${inputClass}" placeholder="Escribe tu respuesta..." value="${state.selectedAnswer || ''}" ${state.isAnswered ? 'disabled' : ''}></div>`;
            }
            const getChoiceClass = (choice) => {
                 let base = 'w-full text-left p-4 border rounded-md transition-colors flex items-center justify-between';
                 if (!state.isAnswered) return `${base} ${state.selectedAnswer === choice.id ? 'bg-indigo-100 border-indigo-300' : 'bg-neutral-card hover:bg-neutral-bg'}`;
                 if (choice.correct) return `${base} bg-green-50 border-green-300 text-green-800 font-bold`;
                 if (state.selectedAnswer === choice.id && !choice.correct) return `${base} bg-red-50 border-red-300`;
                 return `${base} bg-neutral-card opacity-60`;
            };
            return question.choices.map(choice => `<button data-choice-id="${choice.id}" class="quiz-choice ${getChoiceClass(choice)}"><span><span class="font-bold mr-2 uppercase">${choice.id})</span> ${choice.text}</span>${state.isAnswered && choice.correct ? '<span class="text-feedback-correct"><i data-lucide="check-circle" class="w-5 h-5"></i></span>' : ''}${state.isAnswered && state.selectedAnswer === choice.id && !choice.correct ? '<span class="text-feedback-incorrect"><i data-lucide="x-circle" class="w-5 h-5"></i></span>' : ''}</button>`).join('');
        }

        function checkAnswer(question, state) {
            if (!state.selectedAnswer) return;
            let isCorrect = (question.type === 'fill-in-the-blank') ? state.selectedAnswer.trim().toLowerCase() === question.answer.toLowerCase() : !!question.choices.find(c => c.id === state.selectedAnswer)?.correct;
            
            if (isCorrect) state.score++;
            const selectedText = (question.type === 'fill-in-the-blank') ? state.selectedAnswer : question.choices.find(c => c.id === state.selectedAnswer)?.text || state.selectedAnswer;
            
            const existingAnswerIndex = state.userAnswers.findIndex(ua => ua.questionId === question.id);
            if (existingAnswerIndex !== -1) {
                state.userAnswers[existingAnswerIndex] = { questionId: question.id, selected: selectedText, isCorrect: isCorrect };
            } else {
                state.userAnswers.push({ questionId: question.id, selected: selectedText, isCorrect: isCorrect });
            }
            state.isAnswered = true;
            renderQuiz();
        }

        function attachQuizListeners(question, state) {
             lucide.createIcons();
             document.getElementById('quiz-finish-early').addEventListener('click', () => {
                  state.isEarlyFinish = true;
                  state.currentIndex = AppState.quizzes.combinedQuizzes.length;
                  renderQuizResults(AppState.quizzes.combinedQuizzes, true);
             });
             if (state.isAnswered) {
                 document.getElementById('quiz-next').addEventListener('click', () => {
                     state.currentIndex++;
                     state.isAnswered = false;
                     state.selectedAnswer = null;
                     renderQuiz();
                 });
             } else {
                 document.getElementById('quiz-check').addEventListener('click', () => checkAnswer(question, state));
                 if (question.type === 'fill-in-the-blank') {
                      document.getElementById('fill-in-blank-input').addEventListener('input', (e) => {
                          state.selectedAnswer = e.target.value;
                          document.getElementById('quiz-check').disabled = !e.target.value.trim();
                      });
                 } else {
                      document.querySelectorAll('.quiz-choice').forEach(btn => btn.addEventListener('click', () => {
                          if (state.isAnswered) return;
                          state.selectedAnswer = btn.dataset.choiceId;
                          renderQuiz();
                      }));
                 }
             }
        }

        function renderQuizResults(data, isEarlyFinish = false) {
            const state = AppState.quizzes;
            const totalAnswered = state.userAnswers.length;
            const currentScore = state.userAnswers.filter(a => a.isCorrect).length;

            if (totalAnswered > 0) {
                const temarioNames = state.selectedTemarioIndices.map(i => MOCK_DATA.temarios[i].name);
                const record = { type: 'quizzes', date: new Date().toISOString(), totalQuestions: data.length, answeredCount: totalAnswered, correct: currentScore, incorrect: totalAnswered - currentScore };
                addProgressRecord(temarioNames, record);
            }
            
            const percentage = (totalAnswered > 0) ? (currentScore / totalAnswered) * 100 : 0;
            const circumference = 2 * Math.PI * 54;
            const title = isEarlyFinish ? "Cuestionario Finalizado (Parcial)" : "¡Quiz Terminado!";
            const subtitle = `Aciertos: ${currentScore} / Respondidas: ${totalAnswered} / Total: ${data.length}`;
            
            quizContainer.innerHTML = `<div class="bg-neutral-card p-8 rounded-lg border text-center"><h2 class="text-2xl font-bold mb-4">${title}</h2><div class="my-8 flex justify-center"><svg id="quiz-results-chart" class="w-32 h-32" viewBox="0 0 120 120"><circle class="text-gray-200" stroke-width="12" stroke="currentColor" fill="transparent" r="54" cx="60" cy="60"/><circle class="text-brand-accent" stroke-width="12" stroke-dasharray="${circumference}" stroke-dashoffset="${circumference - (percentage / 100) * circumference}" stroke-linecap="round" stroke="currentColor" fill="transparent" r="54" cx="60" cy="60" style="transition: stroke-dashoffset 0.8s ease-out;"/><text x="60" y="65" font-family="sans-serif" font-size="24" text-anchor="middle" fill="#1a1a1a">${Math.round(percentage)}%</text></svg></div><p class="text-lg">Tu puntuación: <strong>${currentScore} de ${totalAnswered}</strong></p><p class="text-sm text-text-secondary">${subtitle}</p>${isEarlyFinish && totalAnswered < data.length ? `<p class="text-sm text-red-500 mt-2">Atención: Solo se revisarán las ${totalAnswered} preguntas respondidas.</p>` : ''}<div class="mt-8 flex justify-center space-x-4"><button id="quiz-restart" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Reiniciar</button>${totalAnswered > 0 ? `<button id="quiz-review" class="px-6 py-2 bg-brand-accent text-white rounded-md hover:bg-opacity-90">Revisar Respuestas</button>` : ''}</div></div>`;
            
            document.getElementById('quiz-restart').addEventListener('click', () => {
                resetQuizState();
                renderQuiz();
            });

            const reviewBtn = document.getElementById('quiz-review');
            if (reviewBtn) {
                reviewBtn.addEventListener('click', () => {
                    state.isReviewMode = true;
                    renderQuizReview();
                });
            }
        }
        
        function downloadQuizReviewAsPDF(state, data) {
            const doc = new jsPDF();
            const { userAnswers, selectedTemarioIndices } = state;
            const score = userAnswers.filter(a => a.isCorrect).length;
            const topicNames = selectedTemarioIndices.map(i => MOCK_DATA.temarios[i].name).join(', ');
            let y = addSkemiaHeader(doc, `Revisión de Quiz: ${topicNames}`);
            
            const margin = 10;
            const lineHeight = 7;
            const maxWidth = 180;

            doc.setFontSize(12).setFont("helvetica", "bold").text(`Resumen: ${score} de ${userAnswers.length} correctas`, margin, y);
            y += 10;
            
            data.forEach((question, index) => {
                const userAnswer = userAnswers.find(ua => ua.questionId === question.id);
                if (userAnswer) {
                    if (y > 270) {
                        doc.addPage();
                        y = addSkemiaHeader(doc, `Revisión de Quiz (Cont.)`);
                    }
                    
                    doc.setTextColor(0); 
                    doc.setFontSize(10).setFont("helvetica", "bold");
                    const qText = `P. ${index + 1}: ${question.prompt}`;
                    const qLines = doc.splitTextToSize(qText, maxWidth);
                    doc.text(qLines, margin, y);
                    y += qLines.length * lineHeight;

                    const status = userAnswer.isCorrect ? "CORRECTO" : "INCORRECTO";
                    const statusColor = userAnswer.isCorrect ? "#22c55e" : "#ef4444";
                    
                    doc.setFont("helvetica", "normal");
                    const statusLabel = "Resultado: ";
                    const labelWidth = doc.getStringUnitWidth(statusLabel) * doc.getFontSize() / doc.internal.scaleFactor;
                    
                    doc.setTextColor(0).text(statusLabel, margin + 5, y);
                    doc.setTextColor(statusColor).text(status, margin + 5 + labelWidth, y);
                    y += lineHeight;

                    doc.setTextColor(0);
                    const userResponseText = `Tu Respuesta: ${userAnswer.selected}`;
                    const userResponseLines = doc.splitTextToSize(userResponseText, maxWidth - 5);
                    doc.text(userResponseLines, margin + 5, y);
                    y += userResponseLines.length * lineHeight;
                    
                    if (!userAnswer.isCorrect) {
                        let correctDisplay = question.type === 'fill-in-the-blank' ? question.answer : question.choices.find(c => c.correct)?.text || 'N/A';
                        const correctDisplayText = `Respuesta Correcta: ${correctDisplay}`;
                        const correctDisplayLines = doc.splitTextToSize(correctDisplayText, maxWidth - 5);
                        doc.setTextColor(0);
                        doc.text(correctDisplayLines, margin + 5, y);
                        y += correctDisplayLines.length * lineHeight;
                    }

                    if (question.explanation) {
                        doc.setTextColor(100).setFont("helvetica", "italic");
                        const explanationLines = doc.splitTextToSize(`Explicación: ${question.explanation}`, maxWidth - 5);
                        doc.text(explanationLines, margin + 5, y);
                        y += explanationLines.length * lineHeight;
                    }
                    y += 4;
                }
            });
            const fileName = `Skemia_Revision_Quiz_${(MOCK_DATA.temarios[selectedTemarioIndices[0]]?.name || 'Quiz').replace(/[^\w\s]/gi, '').slice(0, 20).trim()}.pdf`;
            doc.save(fileName);
        }

        function renderQuizReview() {
            const state = AppState.quizzes;
            const data = state.combinedQuizzes;
            let reviewHtml = `<div class="bg-neutral-card p-8 rounded-lg border"><h2 class="text-2xl font-bold mb-6 text-center">Revisión del Cuestionario</h2><div class="space-y-6">`;
            data.forEach((question, index) => {
                 const userAnswer = state.userAnswers.find(ua => ua.questionId === question.id);
                 if (userAnswer) {
                      let resultIndicator = userAnswer.isCorrect ? `<span class="text-feedback-correct font-bold">Correcto</span>` : `<span class="text-feedback-incorrect font-bold">Incorrecto</span>`;
                      let correctAnswerDisplay = '';
                      if (question.type === 'multiple-choice' && !userAnswer.isCorrect) {
                          const correctChoice = question.choices.find(c => c.correct);
                          if (correctChoice) correctAnswerDisplay = `<p class="text-sm mt-1 text-green-700">Respuesta correcta: <span class="font-bold uppercase">${correctChoice.id})</span> ${correctChoice.text}</p>`;
                      } else if (question.type === 'fill-in-the-blank' && !userAnswer.isCorrect) {
                          correctAnswerDisplay = `<p class="text-sm mt-1 text-green-700">Respuesta correcta: <strong class="font-bold">${question.answer}</strong></p>`;
                      }
                      reviewHtml += `<div class="p-4 border rounded-md"><p class="font-semibold text-base mb-2">P. ${index + 1}: ${question.prompt}</p><p class="text-sm">Tu respuesta: <span class="font-mono p-1 bg-gray-100 rounded text-sm">${userAnswer.selected}</span> - ${resultIndicator}</p>${correctAnswerDisplay}${question.explanation ? `<p class="text-sm mt-2 text-text-secondary">${question.explanation}</p>` : ''}</div>`;
                 }
            });
            reviewHtml += `</div><div class="mt-8 flex justify-center items-center flex-wrap gap-4"><button id="quiz-review-download" class="px-6 py-2 bg-brand-accent text-white rounded-md hover:bg-opacity-90 flex items-center space-x-2 text-sm"><i data-lucide="download" class="w-4 h-4"></i><span>Descargar Revisión (PDF)</span></button><button id="quiz-back-to-results" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Volver a Resultados</button></div></div>`;
            quizContainer.innerHTML = reviewHtml;
            lucide.createIcons();
            document.getElementById('quiz-review-download').addEventListener('click', () => downloadQuizReviewAsPDF(state, data));
            document.getElementById('quiz-back-to-results').addEventListener('click', () => {
                 state.isReviewMode = false;
                 renderQuizResults(data, state.isEarlyFinish); 
            });
        }
        
        function setupMultiSelect(type) {
            const state = AppState[type];
            const optionsContainer = document.getElementById(`${type}-session-options`);
            const totalCountEl = document.getElementById(`${type}-total-count`);

            const dropdown = document.getElementById(`${type === 'flashcards' ? '' : 'quiz-'}multi-select-dropdown`);
            dropdown.innerHTML = MOCK_DATA.temarios.map((temario, index) => `<label class="flex items-center p-2 hover:bg-gray-100 cursor-pointer"><input type="checkbox" data-index="${index}" class="mr-2" ${state.selectedTemarioIndices.includes(index) ? 'checked' : ''}><span>${temario.name}</span></label>`).join('');
            
            updateMultiSelectButtonText(type);

            let totalCount = 0;
            state.selectedTemarioIndices.forEach(index => {
                const items = (type === 'flashcards') ? MOCK_DATA.temarios[index].flashcards : MOCK_DATA.temarios[index].quizzes;
                if (items) totalCount += items.length;
            });
            
            totalCountEl.textContent = totalCount;
            if (totalCount > 0) {
                optionsContainer.classList.remove('hidden');
            } else {
                optionsContainer.classList.add('hidden');
            }
        }

        function updateMultiSelectButtonText(type) {
            const state = AppState[type];
            const buttonText = document.getElementById(`${type === 'flashcards' ? '' : 'quiz-'}multi-select-text`);
            const startBtn = document.getElementById(`start-${type === 'flashcards' ? 'flashcards' : 'quiz'}-btn`);
            const count = state.selectedTemarioIndices.length;
            startBtn.disabled = count === 0;

            if (count === 0) buttonText.textContent = 'Selecciona temarios...';
            else if (count === 1) buttonText.textContent = MOCK_DATA.temarios[state.selectedTemarioIndices[0]].name;
            else buttonText.textContent = `${count} temarios seleccionados`;

            // Actualizar la UI de tamaño de sesión
            const optionsContainer = document.getElementById(`${type}-session-options`);
            const totalCountEl = document.getElementById(`${type}-total-count`);
            let totalCount = 0;
            state.selectedTemarioIndices.forEach(index => {
                const items = (type === 'flashcards') ? MOCK_DATA.temarios[index].flashcards : MOCK_DATA.temarios[index].quizzes;
                if (items) totalCount += items.length;
            });
            totalCountEl.textContent = totalCount;
            if (totalCount > 0) {
                optionsContainer.classList.remove('hidden');
            } else {
                optionsContainer.classList.add('hidden');
            }
        }
        
        ['flashcards', 'quizzes'].forEach(type => {
            const prefix = type === 'flashcards' ? '' : 'quiz-';
            document.getElementById(`${prefix}multi-select-button`).addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById(`${prefix}multi-select-dropdown`).classList.toggle('hidden');
            });
            document.getElementById(`${prefix}multi-select-dropdown`).addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const index = parseInt(e.target.dataset.index, 10);
                    const state = AppState[type];
                    if (e.target.checked) state.selectedTemarioIndices.push(index);
                    else state.selectedTemarioIndices = state.selectedTemarioIndices.filter(i => i !== index);
                    updateMultiSelectButtonText(type);
                }
            });
            document.querySelectorAll(`.size-btn-${type}`).forEach(button => {
                button.addEventListener('click', () => {
                    document.getElementById(`${type}-session-size`).value = button.dataset.size;
                });
            });
        });

        document.addEventListener('click', (e) => {
             if (!e.target.closest('#multi-select-container')) document.getElementById('multi-select-dropdown')?.classList.add('hidden');
             if (!e.target.closest('#quiz-multi-select-container')) document.getElementById('quiz-multi-select-dropdown')?.classList.add('hidden');
        });
        
        function renderMindmapPage() {
            const container = document.getElementById('mindmap-url-container');
            const temario = MOCK_DATA.temarios[AppState.currentTemarioIndex];
            if (temario && temario.mindmapUrl) {
                 container.innerHTML = `<div class="bg-neutral-card p-8 border rounded-lg mt-8 text-center"><a href="${temario.mindmapUrl}" target="_blank" rel="noopener noreferrer" class="inline-block px-8 py-3 bg-brand-accent text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90">Abrir Mapa Mental</a><p class="text-text-secondary mt-4 text-sm max-w-md mx-auto">Haz doble clic sobre cualquier nodo para expandir o contraer sus ramificaciones.</p></div>`;
            } else {
                 container.innerHTML = `<div class="bg-neutral-card p-8 border rounded-lg mt-8 text-center"><p class="text-text-secondary">No hay mapa mental para este temario.</p></div>`;
            }
        }

        function renderDownloadPage(pageType) {
            const config = {
                 audios: { containerId: 'audios-download-container', urlKey: 'allAudiosUrl', description: 'Descarga un ZIP con los audios de todos los temarios.', buttonText: 'Descargar Audios' },
                 report: { containerId: 'report-download-container', urlKey: 'allReportsUrl', description: 'Descarga un ZIP con las guías de estudio en formato informe.', buttonText: 'Descargar Informes' },
                 fuentes: { containerId: 'fuentes-download-container', urlKey: 'allFuentesUrl', description: 'Descarga un ZIP con todas las fuentes y materiales de referencia.', buttonText: 'Descargar Fuentes' }
            };
            const pageConfig = config[pageType];
            if (!pageConfig) return;
            const container = document.getElementById(pageConfig.containerId);
            const url = MOCK_DATA[pageConfig.urlKey];
            if (url && container) {
                 container.innerHTML = `<div class="bg-neutral-card p-8 border rounded-lg mt-8 text-center"><p class="text-text-secondary mb-6 max-w-md mx-auto">${pageConfig.description}</p><a href="${url}" target="_blank" rel="noopener noreferrer" class="inline-block px-8 py-3 bg-brand-accent text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90">${pageConfig.buttonText}</a></div>`;
            } else if (container) {
                 container.innerHTML = `<div class="bg-neutral-card p-8 border rounded-lg mt-8 text-center"><p class="text-text-secondary">No hay archivos disponibles.</p></div>`;
            }
        }

        function renderProgressPage() {
            const progressData = getProgressData();
            const container = document.getElementById('progress-container');
            const modal = document.getElementById('session-details-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            container.innerHTML = '';
            const allRecords = progressData.allSessions || [];

            if (allRecords.length === 0) {
                container.innerHTML = '<p class="text-center text-text-secondary">Aún no has completado ninguna sesión de estudio. ¡Tu progreso aparecerá aquí!</p>';
                return;
            }

            let tableRows = allRecords.sort((a, b) => new Date(b.date) - new Date(a.date)).map(rec => {
                const d = new Date(rec.date);
                const formattedDate = `${d.toLocaleDateString('es-ES')} <span class="text-xs text-gray-500">${d.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})}</span>`;
                let resultsText = rec.type === 'flashcards' ? `Estudiadas: ${rec.studiedCount}/${rec.totalInDeck}` : `Aciertos: ${rec.correct}/${rec.answeredCount}`;
                return `<tr class="border-t hover:bg-gray-50"><td class="p-3 text-sm">${formattedDate}</td><td class="p-3 text-sm">${rec.temarioNames.join(', ')}</td><td class="p-3 text-sm">${rec.type === 'flashcards' ? 'Flashcards' : 'Quiz'}</td><td class="p-3 text-sm">${resultsText}</td><td class="p-3 text-center"><button class="view-details-btn text-indigo-600 hover:underline text-sm" data-session-id="${rec.sessionId}">Ver</button></td></tr>`;
            }).join('');

            container.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full w-full bg-white rounded-lg shadow-md"><thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha y Hora</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tema(s)</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Resultados</th><th class="p-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Detalles</th></tr></thead><tbody class="divide-y divide-gray-200">${tableRows}</tbody></table></div>`;
            
            container.querySelectorAll('.view-details-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sessionId = e.target.dataset.sessionId;
                    const record = allRecords.find(r => r.sessionId === sessionId);
                    if (!record) return;

                    let detailsHtml = '';
                    if (record.type === 'flashcards') {
                        const { studiedCount: studied, easy, medium, hard, totalInDeck } = record;
                        const greenPercent = studied > 0 ? ((easy / studied) * 100).toFixed(1) : 0;
                        const yellowPercent = studied > 0 ? ((medium / studied) * 100).toFixed(1) : 0;
                        const redPercent = studied > 0 ? ((hard / studied) * 100).toFixed(1) : 0;
                        modalTitle.textContent = 'Detalles de Flashcards';
                        detailsHtml = `<ul class="space-y-2 text-sm"><li><strong>Tarjetas estudiadas:</strong> ${studied} de ${totalInDeck}</li><li class="flex items-center"><div class="w-4 h-4 rounded-full bg-green-500 mr-2"></div><strong>Fácil:</strong> ${easy} (${greenPercent}%)</li><li class="flex items-center"><div class="w-4 h-4 rounded-full bg-yellow-400 mr-2"></div><strong>Medio:</strong> ${medium} (${yellowPercent}%)</li><li class="flex items-center"><div class="w-4 h-4 rounded-full bg-red-500 mr-2"></div><strong>Difícil:</strong> ${hard} (${redPercent}%)</li></ul>`;
                    } else if (record.type === 'quizzes') {
                        const { answeredCount: answered, correct, incorrect, totalQuestions } = record;
                        const correctPercent = answered > 0 ? ((correct / answered) * 100).toFixed(1) : 0;
                        const incorrectPercent = answered > 0 ? ((incorrect / answered) * 100).toFixed(1) : 0; // CORRECCIÓN
                        modalTitle.textContent = 'Detalles de Quiz';
                        detailsHtml = `<ul class="space-y-2 text-sm"><li><strong>Preguntas respondidas:</strong> ${answered} de ${totalQuestions}</li><li class="flex items-center"><div class="w-4 h-4 rounded-full bg-green-500 mr-2"></div><strong>Correctas:</strong> ${correct} (${correctPercent}%)</li><li class="flex items-center"><div class="w-4 h-4 rounded-full bg-red-500 mr-2"></div><strong>Incorrectas:</strong> ${incorrect} (${incorrectPercent}%)</li></ul>`;
                    }
                    modalContent.innerHTML = detailsHtml;
                    modal.classList.remove('hidden');
                });
            });

            modalCloseBtn.addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });
        }
        
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const navigationLinks = document.getElementById('navigation-links');
        if (mobileMenuButton && navigationLinks) {
            mobileMenuButton.addEventListener('click', () => navigationLinks.classList.toggle('hidden'));
            navigationLinks.querySelectorAll('a').forEach(link => link.addEventListener('click', () => {
                if (window.innerWidth < 768) navigationLinks.classList.add('hidden');
            }));
        }

        populateTemarioSelectors();
        navigateTo('home');
        lucide.createIcons();
    });
    </script>
</body>
</html>
