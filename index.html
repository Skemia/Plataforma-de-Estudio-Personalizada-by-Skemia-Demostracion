<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skemia - Herramienta Educativa Integrada</title>
    <!-- Tailwind CSS desde CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librerías para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Iconos (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Estilos personalizados y utilidades de Tailwind */
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        .page-content {
            display: none; /* Ocultar todas las páginas por defecto */
        }
        .page-content.active {
            display: block; /* Mostrar solo la página activa */
        }
        
        /* Estilos para el efecto de volteo 3D de la flashcard */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        /* Estilo para la barra de progreso discreta */
        .progress-bar-container {
            @apply w-full bg-gray-200 rounded-full h-2 overflow-hidden;
        }

        .progress-bar {
            @apply bg-purple-700 h-2 rounded-full transition-all duration-300 ease-in-out;
        }
        /* Estilo para el botón de shuffle activo */
        .shuffle-btn.active {
             @apply bg-brand-accent text-white;
        }
        .multi-select-dropdown::-webkit-scrollbar {
            width: 8px;
        }
        .multi-select-dropdown::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 4px;
        }
    </style>
    <script>
        // Configuración de Tailwind para que coincida con el diseño
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'neutral-bg': '#f9f9f9',
                        'neutral-card': '#ffffff',
                        'neutral-border': '#e5e5e5',
                        'text-primary': '#1a1a1a',
                        'text-secondary': '#666666',
                        'brand-accent': '#5F476B',
                        'feedback-correct': '#22c55e',
                        'feedback-incorrect': '#ef4444',
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-neutral-bg text-text-primary min-h-screen flex flex-col">

    <!-- Header y Navegación -->
    <header class="bg-neutral-card border-b border-neutral-border sticky top-0 z-10">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" class="text-xl font-bold text-brand-accent" data-page="home">Skemia</a>
            <div class="flex items-center space-x-4 sm:space-x-6 text-text-secondary">
                <a href="#" class="hover:text-text-primary" data-page="flashcards">Flashcards</a>
                <a href="#" class="hover:text-text-primary" data-page="quizzes">Quizzes</a>
                <a href="#" class="hover:text-text-primary" data-page="mindmap">Mapas Mentales</a>
                <a href="#" class="hover:text-text-primary" data-page="audios">Audios</a>
                <a href="#" class="hover:text-text-primary" data-page="report">Informes</a>
                <a href="#" class="hover:text-text-primary" data-page="fuentes">Fuentes</a>
            </div>
        </nav>
    </header>

    <!-- Contenedor principal para las páginas -->
    <main class="flex-grow container mx-auto px-6 py-8">
        
        <!-- Página de Inicio -->
        <section id="page-home" class="page-content active">
            <div class="grid lg:grid-cols-2 gap-16 items-center min-h-[60vh]">
                <div class="text-center lg:text-left">
                    <h1 class="text-4xl lg:text-5xl font-bold text-gray-800 mb-4 leading-tight">
                        Transfarma tu manera de estudiar.
                    </h1>
                    <p class="text-lg text-gray-600 mb-8 max-w-lg mx-auto lg:mx-0">
                        Skemia te ofrece todas las herramientas que necesitas en un solo lugar. Flashcards, quizzes, mapas mentales y más, diseñados para un aprendizaje sin distracciones.
                    </p>
                    <a href="#" id="start-studying-btn" class="inline-block bg-brand-accent text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-opacity-90 transition-transform transform hover:scale-105">
                        Empezar a estudiar
                    </a>
                </div>
                <div class="hidden lg:block p-4">
                    <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:rgb(230, 230, 250);stop-opacity:1" />
                                <stop offset="100%" style="stop-color:rgb(200, 200, 240);stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <path fill="url(#grad1)" d="M48.8,-63.9C63.2,-53.9,74.7,-40.1,79.8,-24.1C84.9,-8.1,83.6,10.2,75.4,24.3C67.2,38.5,52.1,48.6,37,56.5C21.9,64.4,6.9,70.1,-8.5,70.9C-24,71.7,-39.9,67.6,-51.9,58.3C-63.9,49,-72,34.5,-75.8,18.5C-79.6,2.5,-79.1,-15,-71.5,-29.4C-64,-43.8,-49.4,-55.1,-34.5,-63.7C-19.6,-72.3,-4.5,-78.2,10,-79.4C24.5,-80.6,34.5,-73.9,48.8,-63.9Z" transform="translate(100 100)" />
                        <circle cx="150" cy="50" r="10" fill="#5F476B"/>
                        <circle cx="60" cy="160" r="5" fill="#5F476B" opacity="0.7"/>
                        <rect x="40" y="40" width="20" height="20" rx="5" fill="#5F476B" opacity="0.5" transform="rotate(45 50 50)"/>
                    </svg>
                </div>
            </div>
        </section>

        <!-- Página de Flashcards -->
        <section id="page-flashcards" class="page-content">
            <div class="flex flex-col items-center space-y-8">
                <div class="w-full max-w-2xl text-center">
                    <h1 class="text-3xl font-bold mb-4">Flashcards</h1>
                    <div id="flashcard-selection-area" class="w-full max-w-2xl mx-auto text-left">
                        <label class="block text-sm font-medium text-text-secondary mb-1">Selecciona uno o más temarios:</label>
                        <div class="relative" id="multi-select-container">
                            <button id="multi-select-button" class="w-full bg-white p-2 border border-neutral-border rounded-md flex justify-between items-center text-left">
                                <span id="multi-select-text" class="text-text-secondary">Selecciona temarios...</span>
                                <i data-lucide="chevron-down" class="w-5 h-5"></i>
                            </button>
                            <div id="multi-select-dropdown" class="absolute hidden w-full mt-1 bg-white border rounded-md shadow-lg z-20 max-h-60 overflow-y-auto multi-select-dropdown">
                                <!-- Opciones se inyectarán aquí -->
                            </div>
                        </div>
                        <!-- Este es el botón original. Está bien que esté aquí para establecer la PREFERENCIA inicial de barajar. -->
                        <div class="flex items-center space-x-4 mt-4">
                            <button id="start-flashcards-btn" class="flex-grow px-6 py-2 bg-brand-accent text-white rounded-md hover:bg-opacity-90 disabled:bg-gray-300">
                                Empezar Estudio
                            </button>
                             <button id="flashcard-shuffle" title="Barajar tarjetas antes de empezar" class="shuffle-btn p-2 bg-neutral-card border rounded-md hover:bg-neutral-bg transition-colors">
                                 <i data-lucide="shuffle" class="w-5 h-5"></i>
                             </button>
                        </div>
                    </div>
                </div>

                <div id="flashcard-study-area" class="hidden w-full max-w-2xl flex flex-col items-center space-y-8">
                    <div class="w-full flex justify-between items-center">
                           <button id="change-topics-btn" class="text-sm text-indigo-600 hover:underline">Cambiar Temas</button>
                           <!-- ESTE ES EL NUEVO BOTÓN DE RE-BARAJAR AÑADIDO A LA PANTALLA DE ESTUDIO -->
                           <button id="flashcard-shuffle-study" title="Re-barajar mazo y reiniciar" class="shuffle-btn p-2 bg-neutral-card border rounded-md hover:bg-neutral-bg transition-colors">
                                <i data-lucide="shuffle" class="w-5 h-5"></i>
                           </button>
                    </div>
                    <div id="flashcard-container" class="w-full max-w-2xl"></div>
                    <div id="flashcard-difficulty-controls" class="w-full max-w-2xl p-4 bg-neutral-card border rounded-lg text-center">
                         <p class="text-sm text-text-secondary mb-3">¿Qué tal te sabes esta tarjeta?</p>
                         <div class="flex justify-center space-x-3">
                              <button data-difficulty="hard" class="flex-1 px-4 py-2 bg-red-100 text-red-700 border border-red-200 rounded-md hover:bg-red-200 transition-colors">Difícil</button>
                              <button data-difficulty="medium" class="flex-1 px-4 py-2 bg-yellow-100 text-yellow-700 border border-yellow-200 rounded-md hover:bg-yellow-200 transition-colors">Medio</button>
                              <button data-difficulty="easy" class="flex-1 px-4 py-2 bg-green-100 text-green-700 border border-green-200 rounded-md hover:bg-green-200 transition-colors">Fácil</button>
                         </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="flashcard-prev" class="px-4 py-2 bg-neutral-card border rounded-md hover:bg-neutral-bg transition-transform transform hover:scale-105">Anterior</button>
                        <!-- BOTÓN DE DESCARGA -->
                        <button id="flashcard-download" title="Descargar mazo completo en PDF" class="px-4 py-2 bg-brand-accent text-white rounded-md hover:bg-opacity-90 transition-transform transform hover:scale-105 flex items-center space-x-2 text-sm">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            <span>Descargar Mazo (PDF)</span>
                        </button>
                        <span id="flashcard-counter" class="text-text-secondary"></span>
                        <button id="flashcard-next" class="px-4 py-2 bg-neutral-card border rounded-md hover:bg-neutral-bg transition-transform transform hover:scale-105">Siguiente</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Página de Quizzes -->
        <section id="page-quizzes" class="page-content">
            <div class="flex flex-col items-center space-y-8">
                <div class="w-full max-w-2xl text-center">
                    <h1 class="text-3xl font-bold mb-4">Quizzes</h1>
                    <div id="quiz-selection-area" class="w-full max-w-2xl mx-auto text-left">
                        <label class="block text-sm font-medium text-text-secondary mb-1">Selecciona uno o más temarios:</label>
                        <div class="relative" id="quiz-multi-select-container">
                            <button id="quiz-multi-select-button" class="w-full bg-white p-2 border border-neutral-border rounded-md flex justify-between items-center text-left">
                                <span id="quiz-multi-select-text" class="text-text-secondary">Selecciona temarios...</span>
                                <i data-lucide="chevron-down" class="w-5 h-5"></i>
                            </button>
                            <div id="quiz-multi-select-dropdown" class="absolute hidden w-full mt-1 bg-white border rounded-md shadow-lg z-20 max-h-60 overflow-y-auto multi-select-dropdown">
                                <!-- Opciones se inyectarán aquí -->
                            </div>
                        </div>
                        <div class="flex items-center space-x-4 mt-4">
                            <button id="start-quiz-btn" class="flex-grow px-6 py-2 bg-brand-accent text-white rounded-md hover:bg-opacity-90 disabled:bg-gray-300">
                                Empezar Quiz
                            </button>
                             <button id="quiz-shuffle-selection" title="Barajar preguntas" class="shuffle-btn p-2 bg-neutral-card border rounded-md hover:bg-neutral-bg transition-colors">
                                 <i data-lucide="shuffle" class="w-5 h-5"></i>
                             </button>
                        </div>
                    </div>
                </div>

                <div id="quiz-study-area" class="hidden w-full max-w-2xl flex-col items-center space-y-8">
                         <div class="w-full flex justify-between items-center">
                              <button id="change-quiz-topics-btn" class="text-sm text-indigo-600 hover:underline">Cambiar Temas</button>
                              <button id="quiz-shuffle-study" title="Reiniciar y barajar" class="shuffle-btn p-2 bg-neutral-card border rounded-md hover:bg-neutral-bg transition-colors">
                                  <i data-lucide="shuffle" class="w-5 h-5"></i>
                              </button>
                         </div>
                         <div id="quiz-container" class="w-full">
                             <!-- El quiz se renderizará aquí -->
                         </div>
                </div>
            </div>
        </section>

        <!-- Página de Mapas Mentales -->
        <section id="page-mindmap" class="page-content">
             <div class="max-w-2xl mx-auto text-center">
                 <h1 class="text-3xl font-bold mb-4">Mapas Mentales</h1>
                 <div class="mb-6">
                     <label for="mindmap-temario-select" class="block text-sm font-medium text-text-secondary mb-1">Selecciona un temario:</label>
                     <select id="mindmap-temario-select" class="temario-selector w-full p-2 border border-neutral-border rounded-md bg-white"></select>
                 </div>
                 <div id="mindmap-url-container"></div>
             </div>
        </section>

        <!-- Página de Audios -->
        <section id="page-audios" class="page-content">
             <div class="max-w-2xl mx-auto text-center">
                 <h1 class="text-3xl font-bold mb-4">Audios Descargables</h1>
                 <div id="audios-download-container">
                     <!-- Content will be injected by JavaScript -->
                 </div>
             </div>
        </section>

        <!-- Página de Informes -->
        <section id="page-report" class="page-content">
            <div class="max-w-2xl mx-auto text-center">
                <h1 class="text-3xl font-bold mb-4">Informes Descargables</h1>
                <div id="report-download-container">
                    <!-- Content will be injected by JavaScript -->
                </div>
            </div>
        </section>

        <!-- Página de Fuentes -->
        <section id="page-fuentes" class="page-content">
             <div class="max-w-2xl mx-auto text-center">
                 <h1 class="text-3xl font-bold mb-4">Fuentes de Información</h1>
                 <div id="fuentes-download-container">
                     <!-- Content will be injected by JavaScript -->
                 </div>
             </div>
        </section>
    </main>
    
    <footer class="text-center py-4 text-text-secondary text-sm border-t border-neutral-border mt-8">
        © <span id="footer-year"></span> Skemia. Herramienta educativa.
    </footer>

    <script>
    // Aseguramos que la librería jspdf esté disponible globalmente (ya cargada en el <head>)
    const { jsPDF } = window.jspdf;

    document.addEventListener('DOMContentLoaded', async () => {

        let MOCK_DATA;

        // --- CARGA DE DATOS ---
        // Se cargan los datos desde el archivo externo datos.json
        try {
            const response = await fetch('datos.json');
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            MOCK_DATA = await response.json();
        } catch (error) {
            console.error("Error crítico: No se pudieron cargar los datos de la aplicación.", error);
            document.querySelector('main').innerHTML = `
                <div class="text-center p-8 bg-red-50 border border-red-200 rounded-lg">
                    <h1 class="text-2xl font-bold text-red-700">Error al Cargar Contenido</h1>
                    <p class="text-gray-600 mt-2">No se pudo obtener la información necesaria para la aplicación. Por favor, revisa la consola de desarrollador (F12) o intenta recargar la página.</p>
                </div>`;
            return; // Detiene la ejecución del script si los datos no cargan
        }
        
        // --- ESTADO Y LÓGICA DE LA APLICACIÓN ---
        // (El resto del código permanece idéntico)

        let AppState = {
            currentTemarioIndex: 0,
            flashcards: {
                selectedTemarioIndices: [],
                combinedFlashcards: [],
                currentIndex: 0,
                isFlipped: false,
                isShuffled: false,
                originalOrder: [],
                shuffledOrder: [],
                difficulty: {}
            },
            quizzes: {
                selectedTemarioIndices: [],
                combinedQuizzes: [],
                currentIndex: 0,
                selectedAnswer: null,
                isAnswered: false,
                score: 0,
                userAnswers: [],
                isReviewMode: false,
                // Almacena el estado de "finalización temprana" para el renderizado de resultados
                isEarlyFinish: false, 
            }
        };

        const pages = document.querySelectorAll('.page-content');
        const navLinks = document.querySelectorAll('nav a');
        const temarioSelectors = document.querySelectorAll('.temario-selector');
        document.getElementById('footer-year').textContent = new Date().getFullYear();

        function navigateTo(pageId) {
            pages.forEach(page => page.classList.toggle('active', page.id === `page-${pageId}`));
            const activePage = document.querySelector('.page-content.active');
            if (activePage) {
                const pageLogic = activePage.id.replace('page-', '');
                if (pageLogic === 'flashcards') setupFlashcardsPage();
                if (pageLogic === 'quizzes') setupQuizzesPage();
                if (pageLogic === 'mindmap') renderMindmapPage();
                if (pageLogic === 'audios') renderDownloadPage('audios');
                if (pageLogic === 'report') renderDownloadPage('report');
                if (pageLogic === 'fuentes') renderDownloadPage('fuentes');
            }
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo(e.currentTarget.dataset.page);
            });
        });
        
        function populateTemarioSelectors() {
            temarioSelectors.forEach(selector => {
                selector.innerHTML = '';
                MOCK_DATA.temarios.forEach((temario, index) => {
                    selector.innerHTML += `<option value="${index}">${temario.name}</option>`;
                });
                selector.value = AppState.currentTemarioIndex;
            });
        }

        function handleTemarioChange(event) {
            const newIndex = parseInt(event.target.value, 10);
            AppState.currentTemarioIndex = newIndex;
            temarioSelectors.forEach(s => s.value = newIndex);
            const activePageId = document.querySelector('.page-content.active').id.replace('page-', '');
            navigateTo(activePageId);
        }
        
        document.querySelectorAll('.temario-selector').forEach(selector => 
            selector.addEventListener('change', handleTemarioChange)
        );
        
        document.getElementById('start-studying-btn').addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo('flashcards');
        });

        // --- MÓDULO DE FLASHCARDS ---
        const fcSelectionArea = document.getElementById('flashcard-selection-area');
        const fcStudyArea = document.getElementById('flashcard-study-area');
        const startFlashcardsBtn = document.getElementById('start-flashcards-btn');
        const fcContainer = document.getElementById('flashcard-container');
        const fcPrevBtn = document.getElementById('flashcard-prev');
        const fcNextBtn = document.getElementById('flashcard-next');
        const fcCounter = document.getElementById('flashcard-counter');
        const fcShuffleBtn = document.getElementById('flashcard-shuffle'); // Botón de pre-shuffle
        const fcShuffleStudyBtn = document.getElementById('flashcard-shuffle-study'); // Botón de re-shuffle en estudio
        const fcDownloadBtn = document.getElementById('flashcard-download'); // Botón de descarga
        const fcDifficultyControls = document.getElementById('flashcard-difficulty-controls');
        const changeTopicsBtn = document.getElementById('change-topics-btn');

        function setupFlashcardsPage() {
            setupMultiSelect('flashcards');
            fcSelectionArea.classList.remove('hidden');
            fcStudyArea.classList.add('hidden', 'flex'); // Asegura que se oculta correctamente
        }

        startFlashcardsBtn.addEventListener('click', () => {
            fcSelectionArea.classList.add('hidden');
            fcStudyArea.classList.remove('hidden');
            fcStudyArea.classList.add('flex');
            
            resetFlashcardState();
            
            let combined = [];
            AppState.flashcards.selectedTemarioIndices.forEach(index => {
                combined.push(...MOCK_DATA.temarios[index].flashcards);
            });
            
            // Aplica el shuffle si el botón de pre-shuffle está activo
            if (fcShuffleBtn.classList.contains('active')) {
                for (let i = combined.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [combined[i], combined[j]] = [combined[j], combined[i]];
                }
            }
            
            AppState.flashcards.combinedFlashcards = combined;
            renderFlashcard();
        });

        changeTopicsBtn.addEventListener('click', () => setupFlashcardsPage());

        function resetFlashcardState() {
             AppState.flashcards = {
                 ...AppState.flashcards,
                 combinedFlashcards: [],
                 currentIndex: 0,
                 isFlipped: false,
                 // La preferencia de shuffle se mantiene con el botón visual
                 originalOrder: [],
                 shuffledOrder: [],
                 difficulty: {}
             };
        }

        function shuffleAndRestartFlashcards() {
            const state = AppState.flashcards;
            const combined = state.combinedFlashcards;

            if (combined.length === 0) return;

            // Fisher-Yates shuffle
            for (let i = combined.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [combined[i], combined[j]] = [combined[j], combined[i]];
            }
            
            // Reinicia el estudio al primer índice y sin voltear
            state.currentIndex = 0;
            state.isFlipped = false;
            
            // Aplica feedback visual rápido al botón de estudio
            if(fcShuffleStudyBtn) {
                fcShuffleStudyBtn.classList.add('active');
                setTimeout(() => fcShuffleStudyBtn.classList.remove('active'), 300);
            }

            renderFlashcard();
        }

        // Listener para el botón de re-barajar en el modo estudio
        if (fcShuffleStudyBtn) {
             fcShuffleStudyBtn.addEventListener('click', shuffleAndRestartFlashcards);
        }

        /**
         * Añade encabezado de marca a los documentos PDF.
         * @param {jsPDF} doc Instancia de jspdf
         * @param {string} title Título principal del documento
         * @returns {number} Posición Y inicial después del encabezado.
         */
        function addSkemiaHeader(doc, title) {
            const margin = 10;
            const lineHeight = 6;
            let y = 15;
            const logoText = "Skemia";
            const pageWidth = doc.internal.pageSize.getWidth();
            const logoWidth = doc.getStringUnitWidth(logoText) * doc.internal.getFontSize() / doc.internal.scaleFactor;
            const titleFontSize = 14;

            // Logo (Texto simulado con color de marca)
            doc.setFontSize(20);
            doc.setFont("helvetica", "bold");
            doc.setTextColor("#5F476B"); // brand-accent color
            doc.text(logoText, margin, y);
            
            // Título del documento
            doc.setFontSize(titleFontSize);
            doc.setTextColor(0); // Negro
            doc.setFont("helvetica", "bold");
            
            const fullTitle = title;
            const titleWidth = doc.getStringUnitWidth(fullTitle) * titleFontSize / doc.internal.scaleFactor;
            const maxTitleWidth = pageWidth - margin * 2; // Ancho máximo disponible en la página

            // Calculamos el espacio a la derecha del logo + un pequeño margen (e.g., 5mm)
            const logoEnd = margin + logoWidth;
            const titleStartX = logoEnd + 5; 
            const availableWidthForTitle = pageWidth - titleStartX - margin;
            
            // Si el título es muy largo, lo separamos y lo alineamos a la izquierda, después del logo.
            if (doc.getStringUnitWidth(fullTitle) * titleFontSize / doc.internal.scaleFactor > availableWidthForTitle) {
                const splitTitle = doc.splitTextToSize(fullTitle, availableWidthForTitle);
                doc.text(splitTitle, titleStartX, y, { align: 'left' });
                y += splitTitle.length * lineHeight; // Ajustar Y si el título ocupa varias líneas
            } else {
                // Si el título es corto, lo centramos en el espacio restante (de logoEnd a margin derecho)
                // Posición central del espacio disponible: titleStartX + (availableWidthForTitle / 2)
                const centerPoint = titleStartX + (availableWidthForTitle / 2);
                doc.text(fullTitle, centerPoint, y, { align: 'center' });
                y += lineHeight;
            }


            // Nota legal de Skemia
            doc.setFontSize(8);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(150); // Gris
            doc.text("Este material es propiedad exclusiva de Skemia. La difusión, reproducción o distribución sin autorización expresa está prohibida.", margin, y);
            y += lineHeight;

            // Línea divisoria
            doc.line(margin, y, 200, y);
            y += lineHeight + 5; // Espacio después del encabezado
            return y;
        }

        // Función para generar PDF de Flashcards
        function downloadFlashcardsAsPDF() {
            if (AppState.flashcards.combinedFlashcards.length === 0) {
                alert("No hay tarjetas para descargar. Selecciona un temario e inicia el estudio.");
                return;
            }

            const doc = new jsPDF();
            const cards = AppState.flashcards.combinedFlashcards;
            
            const margin = 10;
            const lineHeight = 7;
            const maxWidth = 180;
            const titleFontSize = 14;
            const textFontSize = 10;

            const selectedTopicNames = AppState.flashcards.selectedTemarioIndices
                .map(index => MOCK_DATA.temarios[index].name)
                .join(', ');
            
            // 1. Añadir encabezado de marca
            let y = addSkemiaHeader(doc, `Mazo de Flashcards: ${selectedTopicNames}`);


            doc.setFont("helvetica", "normal");

            cards.forEach((card, index) => {
                // Comprobación de página completa
                if (y > 280) {
                    doc.addPage();
                    y = addSkemiaHeader(doc, `Mazo de Flashcards: ${selectedTopicNames}`); // Re-imprimir cabecera
                }

                // Número de tarjeta
                doc.setFontSize(titleFontSize);
                doc.setFont("helvetica", "bold");
                doc.text(`Tarjeta ${index + 1}:`, margin, y);
                y += lineHeight;

                // Pregunta
                doc.setFontSize(textFontSize);
                doc.setFont("helvetica", "bold");
                doc.text("P: ", margin + 5, y); 
                
                doc.setFont("helvetica", "normal");
                const frontLines = doc.splitTextToSize(card.front, maxWidth - 10);
                doc.text(frontLines, margin + 10, y);
                y += (frontLines.length * lineHeight) + 2;

                // Respuesta
                doc.setFontSize(textFontSize);
                doc.setFont("helvetica", "bold");
                doc.text("R: ", margin + 5, y); 

                doc.setFont("helvetica", "normal");
                const backLines = doc.splitTextToSize(card.back, maxWidth - 10);
                doc.text(backLines, margin + 10, y);
                y += (backLines.length * lineHeight) + lineHeight / 2;
                
                // Separador de tarjetas
                doc.line(margin, y, 200, y);
                y += lineHeight;
            });

            // Generar nombre de archivo
            const firstTopicName = MOCK_DATA.temarios[AppState.flashcards.selectedTemarioIndices[0]]?.name || 'Mazo';
            const fileName = `Skemia_Flashcards_${firstTopicName.replace(/[^\w\s]/gi, '').slice(0, 30).trim().replace(/\s/g, '_')}.pdf`;
            
            doc.save(fileName);
        }

        // Listener para el botón de descarga
        if (fcDownloadBtn) {
            fcDownloadBtn.addEventListener('click', downloadFlashcardsAsPDF);
        }

        function renderFlashcard() {
            const state = AppState.flashcards;
            const currentData = state.combinedFlashcards;
            
            if (currentData.length === 0) {
                 fcContainer.innerHTML = `<div class="w-full h-80 flex items-center justify-center"><p class="text-text-secondary">No hay flashcards en los temarios seleccionados.</p></div>`;
                 fcCounter.textContent = '0 / 0';
                 fcDifficultyControls.style.display = 'none';
                 fcPrevBtn.disabled = true;
                 fcNextBtn.disabled = true;
                 fcDownloadBtn.disabled = true; // Deshabilitar si no hay tarjetas
                 return;
            } else {
                 fcDifficultyControls.style.display = 'block';
                 fcPrevBtn.disabled = false;
                 fcNextBtn.disabled = false;
                 fcDownloadBtn.disabled = false; // Habilitar si hay tarjetas
            }

            if (state.originalOrder.length === 0) {
                 state.originalOrder = currentData.map((_, index) => index);
            }
            // Simplificado: Como la mezcla se hace directamente en combinedFlashcards, no necesitamos order[]
            const card = currentData[state.currentIndex];
            
            const difficulty = state.difficulty[card.id];
            let borderColor = 'border-neutral-border';
            if (difficulty === 'easy') borderColor = 'border-green-400';
            else if (difficulty === 'medium') borderColor = 'border-yellow-400';
            else if (difficulty === 'hard') borderColor = 'border-red-400';

            fcContainer.innerHTML = `
                <div id="card-flipper" class="w-full h-80 rounded-xl shadow-xl cursor-pointer perspective-1000">
                    <div class="relative w-full h-full transition-transform duration-700 transform-style-3d ${state.isFlipped ? 'rotate-y-180' : ''}">
                        <div class="absolute w-full h-full backface-hidden flex flex-col items-center justify-center p-6 bg-white border-4 ${borderColor} rounded-xl">
                            <p class="text-2xl font-semibold text-text-primary text-center">${card.front}</p>
                            <div class="absolute bottom-4 right-4 text-gray-300"><i data-lucide="rotate-cw" class="w-5 h-5"></i></div>
                        </div>
                        <div class="absolute w-full h-full backface-hidden rotate-y-180 flex flex-col items-center justify-center p-6 bg-neutral-bg border-4 ${borderColor} rounded-xl">
                            <p class="text-lg text-text-secondary text-center">${card.back}</p>
                            ${card.audioUrl ? `<audio controls src="${card.audioUrl}" class="mt-4" onclick="event.stopPropagation()"></audio>` : ''}
                        </div>
                    </div>
                </div>`;
            fcCounter.textContent = `${state.currentIndex + 1} / ${currentData.length}`;
            document.getElementById('card-flipper').addEventListener('click', () => {
                state.isFlipped = !state.isFlipped;
                renderFlashcard();
            });
            lucide.createIcons();
        }
        
        fcPrevBtn.addEventListener('click', () => {
            const state = AppState.flashcards;
            const dataLength = state.combinedFlashcards.length;
            if (dataLength === 0) return;
            state.isFlipped = false;
            state.currentIndex = (state.currentIndex - 1 + dataLength) % dataLength;
            renderFlashcard();
        });
        
        fcNextBtn.addEventListener('click', () => {
            const state = AppState.flashcards;
            const dataLength = state.combinedFlashcards.length;
            if (dataLength === 0) return;
            state.isFlipped = false;
            state.currentIndex = (state.currentIndex + 1) % dataLength;
            renderFlashcard();
        });
        
        // El botón de shuffle del área de selección solo alterna su estado 'activo'
        fcShuffleBtn.addEventListener('click', () => {
            fcShuffleBtn.classList.toggle('active');
        });

        fcDifficultyControls.addEventListener('click', (e) => {
            if (e.target.matches('button')) {
                const difficulty = e.target.dataset.difficulty;
                const state = AppState.flashcards;
                // La tarjeta actual se obtiene del índice, ya que combinedFlashcards está reordenado
                const card = state.combinedFlashcards[state.currentIndex];
                if (!card) return;
                
                state.difficulty[card.id] = difficulty;
                renderFlashcard();
                setTimeout(() => fcNextBtn.click(), 200);
            }
        });

        // --- MÓDULO DE QUIZZES ---
        const quizContainer = document.getElementById('quiz-container');
        const quizSelectionArea = document.getElementById('quiz-selection-area');
        const quizStudyArea = document.getElementById('quiz-study-area');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const changeQuizTopicsBtn = document.getElementById('change-quiz-topics-btn');
        const quizShuffleSelectionBtn = document.getElementById('quiz-shuffle-selection');
        const quizShuffleStudyBtn = document.getElementById('quiz-shuffle-study');

        function setupQuizzesPage() {
            setupMultiSelect('quizzes');
            quizSelectionArea.classList.remove('hidden');
            quizStudyArea.classList.add('hidden', 'flex');
            quizShuffleSelectionBtn.classList.remove('active');
        }

        quizShuffleSelectionBtn.addEventListener('click', () => {
            quizShuffleSelectionBtn.classList.toggle('active');
        });

        startQuizBtn.addEventListener('click', () => {
            quizSelectionArea.classList.add('hidden');
            quizStudyArea.classList.remove('hidden');
            quizStudyArea.classList.add('flex');
            
            resetQuizState();
            
            let combined = [];
            AppState.quizzes.selectedTemarioIndices.forEach(index => {
                if(MOCK_DATA.temarios[index].quizzes){
                    combined.push(...MOCK_DATA.temarios[index].quizzes);
                }
            });
            
            if (quizShuffleSelectionBtn.classList.contains('active')) {
                for (let i = combined.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [combined[i], combined[j]] = [combined[j], combined[i]];
                }
            }

            AppState.quizzes.combinedQuizzes = combined;
            renderQuiz();
        });

        quizShuffleStudyBtn.addEventListener('click', () => {
            const state = AppState.quizzes;
            if (state.combinedQuizzes.length === 0) return;

            // Shuffle the quizzes
            for (let i = state.combinedQuizzes.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [state.combinedQuizzes[i], state.combinedQuizzes[j]] = [state.combinedQuizzes[j], state.combinedQuizzes[i]];
            }
            
            // Reset quiz state, keeping the shuffled array
            const shuffledQuizzes = state.combinedQuizzes;
            resetQuizState();
            AppState.quizzes.combinedQuizzes = shuffledQuizzes; // Restore shuffled array
            
            // Aplica feedback visual rápido al botón
            quizShuffleStudyBtn.classList.add('active');
            setTimeout(() => quizShuffleStudyBtn.classList.remove('active'), 300);

            renderQuiz();
        });


        changeQuizTopicsBtn.addEventListener('click', () => setupQuizzesPage());

        function resetQuizState() {
             AppState.quizzes = {
                 ...AppState.quizzes,
                 combinedQuizzes: AppState.quizzes.combinedQuizzes, // Preserve quizzes array but reset progress
                 currentIndex: 0,
                 selectedAnswer: null,
                 isAnswered: false,
                 score: 0,
                 userAnswers: [],
                 isReviewMode: false,
                 isEarlyFinish: false, 
             };
        }

        function renderQuiz() {
            const state = AppState.quizzes;
            const data = state.combinedQuizzes;
            
            if (data.length === 0) {
                 quizContainer.innerHTML = `<p class="text-text-secondary text-center">No hay quizzes en los temarios seleccionados.</p>`;
                 return;
            }

            if (state.isReviewMode) {
                 renderQuizReview();
                 return;
            }

            if (state.currentIndex >= data.length) {
                 renderQuizResults(data);
                 return;
            }

            const question = data[state.currentIndex];
            
            let feedbackBoxHtml = '';
            if (state.isAnswered) {
                 const userAnswer = state.userAnswers.find(ua => ua.questionId === question.id);
                 let correctAnsHtml = '';
                 
                 if (userAnswer && !userAnswer.isCorrect && question.type === 'fill-in-the-blank') {
                      correctAnsHtml = `<p class="text-sm text-green-700">Respuesta correcta: <strong class="font-bold">${question.answer}</strong></p>`;
                 }

                 if (question.explanation || correctAnsHtml) {
                      feedbackBoxHtml = `
                          <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-md text-sm text-yellow-800">
                               ${correctAnsHtml}
                               ${question.explanation ? `<p class="mt-2">${question.explanation}</p>` : ''}
                          </div>
                      `;
                 }
            }


            quizContainer.innerHTML = `
                 <div class="progress-bar-container mb-4">
                      <div class="progress-bar" style="width: ${((state.currentIndex) / data.length) * 100}%"></div>
                 </div>
                 <p class="text-right text-sm text-text-secondary mb-8">Pregunta ${state.currentIndex + 1} de ${data.length}</p>
                 <div class="bg-neutral-card p-8 rounded-lg border">
                      <h2 class="text-2xl font-semibold mb-6">${question.prompt}</h2>
                      <div class="space-y-3">${renderQuestionInput(question, state)}</div>
                      ${feedbackBoxHtml}
                      <div class="mt-6 flex justify-between items-center">
                           <button id="quiz-finish-early" class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors">
                                Finalizar Cuestionario
                           </button>
                           <div>
                               ${state.isAnswered
                                 ? `<button id="quiz-next" class="px-6 py-2 bg-brand-accent text-white rounded-md">Siguiente</button>`
                                 : `<button id="quiz-check" class="px-6 py-2 bg-brand-accent text-white rounded-md disabled:bg-gray-300" ${!state.selectedAnswer ? 'disabled' : ''}>Comprobar</button>`
                               }
                           </div>
                      </div>
                 </div>`;
            attachQuizListeners(question, state);
        }

        function renderQuestionInput(question, state) {
            if (question.type === 'fill-in-the-blank') {
                 let inputClass = 'w-full p-3 border border-neutral-border rounded-md';
                 let iconHtml = '';
                 let value = state.selectedAnswer || '';
                 
                 if (state.isAnswered) {
                      const userAnswer = state.userAnswers.find(ua => ua.questionId === question.id);
                      if (userAnswer) {
                          value = userAnswer.selected;
                          if (userAnswer.isCorrect) {
                              inputClass += ' bg-green-50 border-green-300 text-green-800';
                              iconHtml = '<div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><i data-lucide="check-circle" class="h-5 w-5 text-feedback-correct"></i></div>';
                          } else {
                              inputClass += ' bg-red-50 border-red-300 text-red-800';
                              iconHtml = '<div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><i data-lucide="x-circle" class="h-5 w-5 text-feedback-incorrect"></i></div>';
                          }
                      }
                 }

                 return `
                      <div class="relative">
                          <input type="text" id="fill-in-blank-input" class="${inputClass}" placeholder="Escribe tu respuesta aquí..." value="${value}" ${state.isAnswered ? 'disabled' : ''}>
                          ${iconHtml}
                      </div>
                 `;
            }

            const getChoiceClass = (choice) => {
                 let base = 'w-full text-left p-4 border rounded-md transition-colors flex items-center justify-between';
                 if (!state.isAnswered) return `${base} ${state.selectedAnswer === choice.id ? 'bg-indigo-100 border-indigo-300' : 'bg-neutral-card hover:bg-neutral-bg'}`;
                 if (choice.correct) return `${base} bg-green-50 border-green-300 text-green-800 font-bold`;
                 if (state.selectedAnswer === choice.id && !choice.correct) return `${base} bg-red-50 border-red-300`;
                 return `${base} bg-neutral-card opacity-60`;
            };

            return question.choices.map(choice => `
                 <button data-choice-id="${choice.id}" class="quiz-choice ${getChoiceClass(choice)}">
                      <span><span class="font-bold mr-2 uppercase">${choice.id})</span> ${choice.text}</span>
                      ${state.isAnswered && choice.correct ? '<span class="text-feedback-correct"><i data-lucide="check-circle" class="w-5 h-5"></i></span>' : ''}
                      ${state.isAnswered && state.selectedAnswer === choice.id && !choice.correct ? '<span class="text-feedback-incorrect"><i data-lucide="x-circle" class="w-5 h-5"></i></span>' : ''}
                 </button>`).join('');
        }

        function checkAnswer(question, state) {
            if (!state.selectedAnswer) return;
            let isCorrect = (question.type === 'fill-in-the-blank')
                 ? state.selectedAnswer.trim().toLowerCase() === question.answer.toLowerCase()
                 : question.choices.find(c => c.id === state.selectedAnswer)?.correct;

            if (isCorrect) state.score++;
            
            // Si es una pregunta de rellenar el espacio, asegurarse de que se guarda la respuesta escrita
            const selectedText = question.type === 'fill-in-the-blank' ? state.selectedAnswer : state.selectedAnswer;

            // Verificar si la respuesta ya fue guardada (para no duplicar al hacer clic varias veces en "Comprobar")
            const existingAnswerIndex = state.userAnswers.findIndex(ua => ua.questionId === question.id);
            if (existingAnswerIndex !== -1) {
                state.userAnswers[existingAnswerIndex] = { questionId: question.id, selected: selectedText, isCorrect: isCorrect };
            } else {
                state.userAnswers.push({ questionId: question.id, selected: selectedText, isCorrect: isCorrect });
            }

            state.isAnswered = true;
            renderQuiz();
        }

        function attachQuizListeners(question, state) {
             lucide.createIcons();
             
             // Listener para Finalizar Cuestionario
             document.getElementById('quiz-finish-early').addEventListener('click', () => {
                 // Si la pregunta actual ha sido respondida, se avanza el índice antes de mostrar resultados.
                 if (state.isAnswered) {
                     // Solo contamos la pregunta actual si aún no ha sido registrada como parte de userAnswers
                     const existing = state.userAnswers.find(ua => ua.questionId === question.id);
                     if (!existing && state.selectedAnswer) {
                          checkAnswer(question, state); // Guardamos la respuesta actual si existe
                     }
                     state.currentIndex = state.combinedQuizzes.length; // Simulamos que el índice llegó al final
                 } else {
                     // Si no ha respondido la actual, simplemente saltamos.
                     state.currentIndex = state.combinedQuizzes.length;
                 }
                 // Marcamos como finalización temprana
                 state.isEarlyFinish = true;
                 renderQuizResults(state.combinedQuizzes, state.isEarlyFinish);
             });
             
             if (state.isAnswered) {
                 document.getElementById('quiz-next').addEventListener('click', () => {
                     state.currentIndex++;
                     state.isAnswered = false;
                     state.selectedAnswer = null;
                     renderQuiz();
                 });
             } else {
                 document.getElementById('quiz-check').addEventListener('click', () => checkAnswer(question, state));
                 
                 if (question.type === 'fill-in-the-blank') {
                      const input = document.getElementById('fill-in-blank-input');
                      input.addEventListener('input', () => {
                          state.selectedAnswer = input.value;
                          document.getElementById('quiz-check').disabled = !input.value.trim();
                      });
                 } else {
                      document.querySelectorAll('.quiz-choice').forEach(btn => {
                          btn.addEventListener('click', () => {
                              if (state.isAnswered) return;
                              state.selectedAnswer = btn.dataset.choiceId;
                              renderQuiz(); 
                          });
                      });
                 }
             }
        }

        function renderQuizResults(data, isEarlyFinish = false) {
            const state = AppState.quizzes;
            const totalAnswered = state.userAnswers.length;
            const currentScore = state.userAnswers.filter(a => a.isCorrect).length;
            const totalQuestions = data.length;
            const percentage = (totalAnswered > 0) ? (currentScore / totalAnswered) * 100 : 0;
            const circumference = 2 * Math.PI * 54;
            
            let title = isEarlyFinish ? "Cuestionario Finalizado (Parcial)" : "¡Quiz Terminado!";
            let subtitle = `Aciertos: ${currentScore} / Respondidas: ${totalAnswered} / Total: ${totalQuestions}`;

            quizContainer.innerHTML = `
                 <div class="bg-neutral-card p-8 rounded-lg border text-center">
                      <h2 class="text-2xl font-bold mb-4">${title}</h2>
                      <div class="my-8 flex justify-center">
                           <svg id="quiz-results-chart" class="w-32 h-32" viewBox="0 0 120 120" data-percentage="${percentage}">
                               <circle class="text-gray-200" stroke-width="12" stroke="currentColor" fill="transparent" r="54" cx="60" cy="60"/>
                               <circle class="text-brand-accent" stroke-width="12" stroke-dasharray="${circumference}" stroke-dashoffset="${circumference - (percentage / 100) * circumference}" stroke-linecap="round" stroke="currentColor" fill="transparent" r="54" cx="60" cy="60" style="transition: stroke-dashoffset 0.8s ease-out;"/>
                               <text x="60" y="65" font-family="sans-serif" font-size="24" text-anchor="middle" fill="#1a1a1a">${Math.round(percentage)}%</text>
                           </svg>
                      </div>
                      <p class="text-lg">Tu puntuación: <strong>${currentScore} de ${totalAnswered}</strong></p>
                      <p class="text-sm text-text-secondary">${subtitle}</p>
                      ${isEarlyFinish && totalAnswered < totalQuestions ? `<p class="text-sm text-red-500 mt-2">Atención: Solo se revisarán las ${totalAnswered} preguntas respondidas.</p>` : ''}
                      <div class="mt-8 flex justify-center space-x-4">
                           <button id="quiz-restart" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Reiniciar</button>
                           ${totalAnswered > 0 ? `<button id="quiz-review" class="px-6 py-2 bg-brand-accent text-white rounded-md hover:bg-opacity-90">Revisar Respuestas</button>` : ''}
                      </div>
                 </div>`;
            document.getElementById('quiz-restart').addEventListener('click', () => {
                // Reinicia, pero mantiene el conjunto de preguntas combinadas para que pueda empezar de nuevo
                const combinedQuizzes = data;
                resetQuizState();
                AppState.quizzes.combinedQuizzes = combinedQuizzes;
                renderQuiz();
            });
            if (totalAnswered > 0) {
                document.getElementById('quiz-review').addEventListener('click', () => {
                    state.isReviewMode = true;
                    renderQuizReview();
                });
            }
        }
        
        // Función para generar PDF de la Revisión del Quiz
        function downloadQuizReviewAsPDF(state, data) {
            const doc = new jsPDF();
            const margin = 10;
            const lineHeight = 6;
            const maxWidth = 180;

            const totalAnswered = state.userAnswers.length;
            const currentScore = state.userAnswers.filter(a => a.isCorrect).length;
            const totalQuestions = data.length;
            const percentage = (totalAnswered > 0) ? (currentScore / totalAnswered) * 100 : 0;
            const numIncorrect = totalAnswered - currentScore;

            const selectedTopicNames = AppState.quizzes.selectedTemarioIndices
                .map(index => MOCK_DATA.temarios[index].name)
                .join(', ');

            // 1. Añadir encabezado de marca
            // Título interno del PDF: SIMPLIFICADO: "Revisión de Quiz" + Nombres de los temas
            let y = addSkemiaHeader(doc, `Revisión de Quiz: ${selectedTopicNames}`);

            // --- RESUMEN DE RESULTADOS ---
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("Resumen de Resultados:", margin, y);
            y += lineHeight + 2;

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, margin, y); y += lineHeight;
            doc.text(`Temas incluidos: ${selectedTopicNames}`, margin, y); y += lineHeight;
            doc.text(`Puntuación: ${currentScore} de ${totalAnswered} (${Math.round(percentage)}%)`, margin, y); y += lineHeight;
            doc.text(`Aciertos: ${currentScore}`, margin, y); y += lineHeight;
            doc.text(`Errores: ${numIncorrect}`, margin, y); y += lineHeight;
            doc.text(`Preguntas Totales en el mazo: ${totalQuestions}`, margin, y); y += lineHeight;
            
            // Separador
            y += lineHeight;
            doc.line(margin, y, 200, y); 
            y += lineHeight; 
            
            // --- SECCIÓN DE PREGUNTAS ---
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("Revisión Pregunta por Pregunta:", margin, y);
            y += lineHeight * 2;

            data.forEach((question, index) => {
                 const userAnswer = state.userAnswers.find(ua => ua.questionId === question.id);
                 
                 // Solo incluir preguntas respondidas
                 if (userAnswer) {
                      // Comprobación de página completa
                      if (y > 270) {
                          doc.addPage();
                          // Título de la página de continuación, ajustado
                          y = addSkemiaHeader(doc, `Revisión de Quiz: ${selectedTopicNames} (Cont.)`);
                          doc.setFontSize(14);
                          doc.setFont("helvetica", "bold");
                          doc.text("Revisión Pregunta por Pregunta (Cont.):", margin, y);
                          y += lineHeight * 2;
                      }

                      // Definir el texto de estado
                      const status = userAnswer.isCorrect ? "CORRECTO" : "INCORRECTO";
                      const statusColor = userAnswer.isCorrect ? "#22c55e" : "#ef4444";
                      
                      doc.setFontSize(10);
                      doc.setTextColor(0); 

                      // Pregunta
                      doc.setFont("helvetica", "bold");
                      let promptText = doc.splitTextToSize(`P. ${index + 1}: ${question.prompt}`, maxWidth);
                      doc.text(promptText, margin, y);
                      y += promptText.length * lineHeight;

                      // Estado (Color)
                      doc.setTextColor(statusColor);
                      doc.text(`Resultado: ${status}`, margin + 5, y);
                      y += lineHeight;

                      // Tu Respuesta
                      doc.setTextColor(0); 
                      doc.setFont("helvetica", "normal");
                      let userResp = userAnswer.selected || "Sin respuesta";
                      let userRespText = doc.splitTextToSize(`Tu Respuesta: ${userResp}`, maxWidth);
                      doc.text(userRespText, margin + 5, y);
                      y += userRespText.length * lineHeight;
                      
                      // Respuesta Correcta
                      let correctDisplay = '';
                      if (question.type === 'multiple-choice') {
                          const correctChoice = question.choices.find(c => c.correct);
                          correctDisplay = correctChoice ? `(${correctChoice.id.toUpperCase()}) ${correctChoice.text}` : 'N/A';
                      } else if (question.type === 'fill-in-the-blank') {
                          correctDisplay = question.answer;
                      }

                      doc.setTextColor("#22c55e");
                      let correctText = doc.splitTextToSize(`Respuesta Correcta: ${correctDisplay}`, maxWidth);
                      doc.text(correctText, margin + 5, y);
                      y += correctText.length * lineHeight;
                      
                      // Explicación (si existe)
                      if (question.explanation) {
                          doc.setTextColor(100); 
                          doc.setFont("helvetica", "italic");
                          let explanationText = doc.splitTextToSize(`Explicación: ${question.explanation}`, maxWidth);
                          doc.text(explanationText, margin + 5, y);
                          y += explanationText.length * lineHeight;
                          doc.setFont("helvetica", "normal");
                      }

                      y += lineHeight; // Espacio entre tarjetas
                 }
            });

            // Generar nombre de archivo con el nombre del tema
            const firstTopicName = MOCK_DATA.temarios[AppState.quizzes.selectedTemarioIndices[0]]?.name || 'Quiz';
            // Limpiar y acortar el nombre del tema para el nombre del archivo
            const cleanTopicName = firstTopicName.replace(/[^\w\s]/gi, '').slice(0, 30).trim().replace(/\s/g, '_');
            const fileName = `Skemia_Revision_Quiz_${cleanTopicName}.pdf`;

            doc.save(fileName);
        }

        function renderQuizReview() {
            const state = AppState.quizzes;
            const data = state.combinedQuizzes;
            let reviewHtml = `<div class="bg-neutral-card p-8 rounded-lg border"><h2 class="text-2xl font-bold mb-6 text-center">Revisión del Cuestionario</h2><div class="space-y-6">`;

            // Filtramos las preguntas para incluir solo las que el usuario respondió (userAnswers tiene el registro)
            data.forEach((question, index) => {
                 const userAnswer = state.userAnswers.find(ua => ua.questionId === question.id);
                 
                 // Solo mostramos la revisión si hay una respuesta registrada
                 if (userAnswer) {
                      // Mantenemos los emojis para la visualización en pantalla (HTML)
                      let resultIndicator = userAnswer.isCorrect ? `<span class="text-feedback-correct font-bold">Correcto</span>` : `<span class="text-feedback-incorrect font-bold">Incorrecto</span>`;
                      
                      // Determinar la respuesta correcta para preguntas de opción múltiple
                      let correctAnswerDisplay = '';
                      if (question.type === 'multiple-choice') {
                          const correctChoice = question.choices.find(c => c.correct);
                          if (correctChoice) {
                              correctAnswerDisplay = `<p class="text-sm mt-1 text-green-700">Respuesta correcta: <span class="font-bold uppercase">${correctChoice.id})</span> ${correctChoice.text}</p>`;
                          }
                      } else if (question.type === 'fill-in-the-blank' && !userAnswer.isCorrect) {
                          correctAnswerDisplay = `<p class="text-sm mt-1 text-green-700">Respuesta correcta: <strong class="font-bold">${question.answer}</strong></p>`;
                      }

                      reviewHtml += `
                           <div class="p-4 border rounded-md">
                               <p class="font-semibold text-base mb-2">P. ${index + 1}: ${question.prompt}</p>
                               <p class="text-sm">Tu respuesta: <span class="font-mono p-1 bg-gray-100 rounded text-sm">${userAnswer.selected}</span> - ${resultIndicator}</p>
                               ${correctAnswerDisplay}
                               ${question.explanation ? `<p class="text-sm mt-2 text-text-secondary">${question.explanation}</p>` : ''}
                           </div>`;
                 }
            });

            reviewHtml += `</div>
            <div class="mt-8 flex justify-center space-x-4">
                <button id="quiz-review-download" class="px-6 py-2 bg-brand-accent text-white rounded-md hover:bg-opacity-90 flex items-center space-x-2 text-sm">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    <span>Descargar Revisión (PDF)</span>
                </button>
                <button id="quiz-back-to-results" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Volver a Resultados</button>
            </div>
            </div>`;
            
            quizContainer.innerHTML = reviewHtml;
            lucide.createIcons(); // Crear iconos para el botón de descarga

            document.getElementById('quiz-review-download').addEventListener('click', () => {
                downloadQuizReviewAsPDF(state, data);
            });
            
            document.getElementById('quiz-back-to-results').addEventListener('click', () => {
                 state.isReviewMode = false;
                 // Usamos AppState.quizzes.isEarlyFinish para saber qué título mostrar en el resumen.
                 renderQuizResults(data, AppState.quizzes.isEarlyFinish); 
            });
        }
        
        // --- LÓGICA GENÉRICA Y MULTI-SELECT ---
        function setupMultiSelect(type) {
            const state = AppState[type];
            const dropdown = document.getElementById(`${type === 'flashcards' ? '' : 'quiz-'}multi-select-dropdown`);
            
            dropdown.innerHTML = '';
            MOCK_DATA.temarios.forEach((temario, index) => {
                 const isChecked = state.selectedTemarioIndices.includes(index);
                 dropdown.innerHTML += `
                     <label class="flex items-center p-2 hover:bg-gray-100 cursor-pointer">
                         <input type="checkbox" data-index="${index}" class="mr-2" ${isChecked ? 'checked' : ''}>
                         <span>${temario.name}</span>
                     </label>`;
            });
            updateMultiSelectButtonText(type);
        }

        function updateMultiSelectButtonText(type) {
            const state = AppState[type];
            const buttonText = document.getElementById(`${type === 'flashcards' ? '' : 'quiz-'}multi-select-text`);
            const startBtn = document.getElementById(`start-${type === 'flashcards' ? 'flashcards' : 'quiz'}-btn`);
            const selectedCount = state.selectedTemarioIndices.length;

            if (selectedCount === 0) {
                 buttonText.textContent = 'Selecciona temarios...';
                 buttonText.classList.add('text-text-secondary');
                 startBtn.disabled = true;
            } else if (selectedCount === 1) {
                 const selectedIndex = state.selectedTemarioIndices[0];
                 buttonText.textContent = MOCK_DATA.temarios[selectedIndex].name;
                 buttonText.classList.remove('text-text-secondary');
                 startBtn.disabled = false;
            } else {
                 buttonText.textContent = `${selectedCount} temarios seleccionados`;
                 buttonText.classList.remove('text-text-secondary');
                 startBtn.disabled = false;
            }
        }
        
        ['flashcards', 'quizzes'].forEach(type => {
            const prefix = type === 'flashcards' ? '' : 'quiz-';
            document.getElementById(`${prefix}multi-select-button`).addEventListener('click', (e) => {
                 e.stopPropagation();
                 document.getElementById(`${prefix}multi-select-dropdown`).classList.toggle('hidden');
            });
            document.getElementById(`${prefix}multi-select-dropdown`).addEventListener('change', (e) => {
                 if (e.target.type === 'checkbox') {
                     const index = parseInt(e.target.dataset.index, 10);
                     const state = AppState[type];
                     if (e.target.checked) {
                         state.selectedTemarioIndices.push(index);
                     } else {
                         state.selectedTemarioIndices = state.selectedTemarioIndices.filter(i => i !== index);
                     }
                     updateMultiSelectButtonText(type);
                 }
            });
        });

        document.addEventListener('click', (e) => {
             // Ocultar dropdowns al hacer clic fuera
             if (!e.target.closest('#multi-select-container')) {
                 document.getElementById('multi-select-dropdown')?.classList.add('hidden');
             }
             if (!e.target.closest('#quiz-multi-select-container')) {
                 document.getElementById('quiz-multi-select-dropdown')?.classList.add('hidden');
             }
        });
        
        // --- MÓDULOS DE URL GENÉRICAS E INFORMES ---
        function renderMindmapPage() {
            const container = document.getElementById('mindmap-url-container');
            const temario = MOCK_DATA.temarios[AppState.currentTemarioIndex];
            const url = temario.mindmapUrl;

            if (url) {
                 container.innerHTML = `
                      <div class="bg-neutral-card p-8 border border-neutral-border rounded-lg mt-8 text-center">
                          <a href="${url}" target="_blank" rel="noopener noreferrer" class="inline-block px-8 py-3 bg-brand-accent text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition-transform transform hover:scale-105">
                              Abrir Mapa Mental
                          </a>
                          <p class="text-text-secondary mt-4 text-sm max-w-md mx-auto">
                              Nuestros mapas mentales son interactivos. Haz doble clic sobre cualquier idea o nodo para expandir o contraer sus ramificaciones y explorar el contenido a tu propio ritmo.
                          </p>
                      </div>`;
            } else {
                 container.innerHTML = `
                      <div class="bg-neutral-card p-8 border border-neutral-border rounded-lg mt-8 text-center">
                           <p class="text-text-secondary">No hay un mapa mental asociado a este temario.</p>
                      </div>`;
            }
        }

        function renderDownloadPage(pageType) {
            const config = {
                 audios: {
                     containerId: 'audios-download-container',
                     urlKey: 'allAudiosUrl',
                     description: 'Haz clic en el botón para descargar un único archivo ZIP con los audios de todos los temarios disponibles.',
                     buttonText: 'Descargar Audios'
                 },
                 report: {
                     containerId: 'report-download-container',
                     urlKey: 'allReportsUrl',
                     description: 'Al pulsar el botón, descargarás un archivo ZIP que contiene las guías de estudio para cada tema, todas redactadas en formato de informe.',
                     buttonText: 'Descargar Informes'
                 },
                 fuentes: {
                     containerId: 'fuentes-download-container',
                     urlKey: 'allFuentesUrl',
                     description: 'Haz clic en el botón para descargar un único archivo ZIP con todas las fuentes y materiales de referencia.',
                     buttonText: 'Descargar Fuentes'
                 }
            };

            const pageConfig = config[pageType];
            if (!pageConfig) return;

            const container = document.getElementById(pageConfig.containerId);
            const url = MOCK_DATA[pageConfig.urlKey];

            if (url && container) {
                 container.innerHTML = `
                      <div class="bg-neutral-card p-8 border border-neutral-border rounded-lg mt-8 text-center">
                          <p class="text-text-secondary mb-6 max-w-md mx-auto">
                              ${pageConfig.description}
                          </p>
                          <a href="${url}" target="_blank" rel="noopener noreferrer" class="inline-block px-8 py-3 bg-brand-accent text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition-transform transform hover:scale-105">
                              ${pageConfig.buttonText}
                          </a>
                      </div>`;
            } else if (container) {
                 container.innerHTML = `
                      <div class="bg-neutral-card p-8 border border-neutral-border rounded-lg mt-8 text-center">
                           <p class="text-text-secondary">Actualmente no hay archivos disponibles para descargar.</p>
                      </div>`;
            }
        }
        
        // --- INICIALIZACIÓN ---
        populateTemarioSelectors();
        navigateTo('home');
        lucide.createIcons();
    });
    </script>
</body>
</html>
